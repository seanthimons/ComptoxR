---
phase: 25-automated-test-generation-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - dev/generate_tests.R
autonomous: true
requirements:
  - AUTO-02
  - AUTO-06

must_haves:
  truths:
    - "Running `Rscript dev/generate_tests.R` generates test files for all detected gaps and respects manifest protection"
    - "Protected test files in the manifest are never overwritten — skipped with a warning"
    - "Newly generated test files are automatically registered in dev/test_manifest.json as 'generated'"
    - "The script outputs GITHUB_OUTPUT variables (tests_generated, tests_skipped, gaps_remaining) when in CI"
    - "Running generate stubs then generate tests produces matched stub+test pairs (AUTO-06)"
    - "The script can be run standalone (locally) without CI environment"
  artifacts:
    - path: "dev/generate_tests.R"
      provides: "Extended test generator with manifest support, gap-aware generation, and GITHUB_OUTPUT"
      min_lines: 200
  key_links:
    - from: "dev/generate_tests.R"
      to: "dev/test_manifest.json"
      via: "read_test_manifest()/write_test_manifest() to check protection and register new files"
      pattern: "read_test_manifest|write_test_manifest"
    - from: "dev/generate_tests.R"
      to: "R/*.R"
      via: "extract_function_formals() and extract_tidy_flag() parse function metadata"
      pattern: "extract_function_formals|extract_tidy_flag"
    - from: "dev/generate_tests.R"
      to: "GITHUB_OUTPUT"
      via: "Conditional CI output variables for PR body reporting"
      pattern: "GITHUB_OUTPUT"
---

<objective>
Extend the existing test generator with manifest integration, overwrite protection, and CI output variables.

Purpose: AUTO-02 requires the generator to produce tests for all detected gaps. AUTO-06 requires integration with the stub pipeline (running generate_stubs.R then generate_tests.R produces matched pairs). The manifest integration enables the overwrite protection system from CONTEXT.md decisions.
Output: Updated `dev/generate_tests.R` with manifest support and GITHUB_OUTPUT
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-automated-test-generation-pipeline/25-CONTEXT.md
@.planning/phases/25-automated-test-generation-pipeline/25-RESEARCH.md

<interfaces>
<!-- Existing generate_tests.R functions (to be extended, not rewritten) -->

From dev/generate_tests.R:
```r
# KEEP THESE UNCHANGED:
extract_function_formals(file_path, function_name)  # Parse-based parameter extraction
extract_formals_regex(file_path, function_name)      # Regex fallback
extract_tidy_flag(file_path)                         # Tidy flag from function body
get_test_value_for_param(param_name, param_examples)  # Parameter value mapping
get_batch_test_values(param_name)                     # Batch value generation
generate_test_file(function_name, function_file, output_dir)  # Single test file generator

# MODIFY THIS:
generate_all_tests(r_dir, test_dir, force)           # Main entry point — add manifest + GITHUB_OUTPUT
```

From dev/detect_test_gaps.R (Plan 01 creates these — use same manifest helpers):
```r
# Manifest helpers (will be defined in detect_test_gaps.R):
read_test_manifest()           # Returns list(version, updated, files)
write_test_manifest(manifest)  # Writes to dev/test_manifest.json
is_protected(test_filename, manifest)  # Check protection status
calls_generic_request(file_path)       # AST-based API wrapper detection
has_real_tests(test_file_path)         # Check for real test_that() blocks
```

From dev/calculate_coverage.R (GITHUB_OUTPUT pattern):
```r
if (Sys.getenv("GITHUB_OUTPUT") != "") {
  output_file <- Sys.getenv("GITHUB_OUTPUT")
  cat(sprintf("key=%s\n", value), file = output_file, append = TRUE)
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add manifest support and CI output to generate_tests.R</name>
  <files>dev/generate_tests.R</files>
  <action>
Modify the existing `dev/generate_tests.R` — do NOT rewrite from scratch. The existing helper functions (extract_function_formals, extract_tidy_flag, get_test_value_for_param, get_batch_test_values, generate_test_file) stay as-is. Changes:

**1. Add manifest helper functions** (duplicate from detect_test_gaps.R for standalone operation — both scripts need to work independently per CONTEXT.md decision):

Add at the top of the file (after library imports):
```r
# Manifest helpers (shared pattern with detect_test_gaps.R)
read_test_manifest <- function() {
  manifest_path <- file.path(here::here(), "dev", "test_manifest.json")
  if (!file.exists(manifest_path)) {
    return(list(version = "1.0", updated = format(Sys.time(), "%Y-%m-%dT%H:%M:%SZ"), files = list()))
  }
  jsonlite::fromJSON(manifest_path, simplifyVector = FALSE)
}

write_test_manifest <- function(manifest) {
  manifest_path <- file.path(here::here(), "dev", "test_manifest.json")
  jsonlite::write_json(manifest, manifest_path, pretty = TRUE, auto_unbox = TRUE)
}
```

Add `library(jsonlite)` and `library(here)` to the imports at top if not already present.

**2. Modify `generate_test_file()` to check manifest before writing:**

Before the existing `writeLines(test_content, test_file)` line, add:
```r
# Check manifest for protection
manifest <- read_test_manifest()
test_basename <- basename(test_file)
if (!is.null(manifest$files[[test_basename]]) &&
    identical(manifest$files[[test_basename]]$status, "protected")) {
  cli::cli_alert_warning("Skipping protected file: {test_basename}")
  return(invisible(NULL))
}
```

After writing the file, add manifest registration:
```r
# Register in manifest
manifest <- read_test_manifest()
manifest$files[[test_basename]] <- list(
  status = "generated",
  generated_date = format(Sys.time(), "%Y-%m-%dT%H:%M:%SZ")
)
manifest$updated <- format(Sys.time(), "%Y-%m-%dT%H:%M:%SZ")
write_test_manifest(manifest)
```

**3. Modify `generate_all_tests()` to add GITHUB_OUTPUT support:**

After the existing loop that counts generated_count and skipped_count, add:
- Calculate `gaps_remaining` = total API wrapper files minus (generated_count + skipped_count with real tests)
- Write GITHUB_OUTPUT variables if in CI:
  ```r
  gh_output <- Sys.getenv("GITHUB_OUTPUT")
  if (nzchar(gh_output)) {
    cat(sprintf("tests_generated=%d\n", generated_count), file = gh_output, append = TRUE)
    cat(sprintf("tests_skipped=%d\n", skipped_count), file = gh_output, append = TRUE)
    cat(sprintf("gaps_remaining=%d\n", gaps_remaining), file = gh_output, append = TRUE)
  }
  ```

**4. Also add `calls_generic_request()` detection** to `generate_all_tests()` so it only generates tests for actual API wrappers (not utility functions that happen to start with ct_/chemi_/cc_):

In the loop over function_files, before generating, add a check:
```r
# Skip non-API functions (those that don't call generic_request)
if (!calls_generic_request(file)) {
  next
}
```

Add the `calls_generic_request()` helper (same as detect_test_gaps.R):
```r
calls_generic_request <- function(file_path) {
  tryCatch({
    expr <- parse(file = file_path)
    all_calls <- unlist(lapply(expr, all.names))
    any(c("generic_request", "generic_chemi_request", "generic_cc_request") %in% all_calls)
  }, error = function(e) FALSE)
}
```

**5. Update the script entry point** at the bottom to auto-run when sourced as a script (for CI):
```r
if (!interactive()) {
  generate_all_tests()
}
```

This replaces the existing conditional at the bottom which only prints an info message.

**Important notes:**
- Keep the existing `force` parameter in `generate_all_tests()` — when `force = TRUE`, regenerate even if test exists (but still respect manifest protection)
- The manifest check in `generate_test_file()` acts as the final protection gate regardless of force flag
- Both scripts (detect_test_gaps.R and generate_tests.R) work independently per CONTEXT.md — they each have their own manifest helpers
  </action>
  <verify>
    <automated>"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('dev/generate_tests.R'); cat('generate_all_tests exists:', exists('generate_all_tests'), '\n'); cat('read_test_manifest exists:', exists('read_test_manifest'), '\n'); cat('calls_generic_request exists:', exists('calls_generic_request'), '\n')"</automated>
  </verify>
  <done>
  - generate_tests.R sources without error
  - generate_test_file() checks manifest before writing and skips protected files
  - generate_test_file() registers newly created files in manifest as "generated"
  - generate_all_tests() writes GITHUB_OUTPUT variables when in CI
  - generate_all_tests() filters to API wrapper functions only (calls_generic_request check)
  - Non-interactive execution triggers generate_all_tests() automatically
  - Existing helper functions (extract_function_formals, extract_tidy_flag, etc.) unchanged
  </done>
</task>

</tasks>

<verification>
1. Run `Rscript -e "source('dev/generate_tests.R'); cat('OK\n')"` — sources without error
2. Run `Rscript -e "source('dev/generate_tests.R'); m <- read_test_manifest(); cat('Manifest version:', m$version, '\n')"` — manifest readable
3. Verify `generate_test_file()` contains manifest protection check (grep for "protected")
4. Verify `generate_all_tests()` contains GITHUB_OUTPUT writing (grep for "GITHUB_OUTPUT")
5. Verify `calls_generic_request()` exists and filters non-API functions
</verification>

<success_criteria>
- `dev/generate_tests.R` sources cleanly with manifest, CI output, and API-wrapper filtering
- Protected files are never overwritten
- Generated files are tracked in manifest
- GITHUB_OUTPUT variables match the pattern: tests_generated, tests_skipped, gaps_remaining
- Script works both locally (interactive) and in CI (non-interactive)
</success_criteria>

<output>
After completion, create `.planning/phases/25-automated-test-generation-pipeline/25-02-SUMMARY.md`
</output>
