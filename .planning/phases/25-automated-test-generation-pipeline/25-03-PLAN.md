---
phase: 25-automated-test-generation-pipeline
plan: 03
type: execute
wave: 2
depends_on:
  - 25-01
  - 25-02
files_modified:
  - .github/workflows/schema-check.yml
autonomous: true
requirements:
  - AUTO-03
  - AUTO-04

must_haves:
  truths:
    - "Schema-check workflow includes gap detection step after documentation update"
    - "Schema-check workflow includes test generation step that runs when gaps are found"
    - "Test generation steps run only when schema changes are detected (conditional on schema_changes)"
    - "PR body includes a 'Test Gaps & Generation' section showing tests generated, skipped, and remaining gaps"
    - "Generated test files are committed alongside schemas, stubs, and docs in the same automated PR"
    - "Workflow supports both scheduled triggers and manual workflow_dispatch"
  artifacts:
    - path: ".github/workflows/schema-check.yml"
      provides: "Extended schema-check workflow with gap detection and test generation steps"
      contains: "Detect test gaps"
  key_links:
    - from: ".github/workflows/schema-check.yml"
      to: "dev/detect_test_gaps.R"
      via: "Rscript step sourcing the gap detection script"
      pattern: "detect_test_gaps"
    - from: ".github/workflows/schema-check.yml"
      to: "dev/generate_tests.R"
      via: "Rscript step sourcing the test generator"
      pattern: "generate_tests"
    - from: ".github/workflows/schema-check.yml"
      to: "pr_body.md"
      via: "Steps.gaps and steps.tests outputs interpolated into PR body"
      pattern: "steps\\.gaps\\.outputs|steps\\.tests\\.outputs"
---

<objective>
Integrate gap detection and test generation into the existing schema-check.yml GitHub Actions workflow.

Purpose: AUTO-03 requires the workflow to detect new/changed stubs and generate corresponding test files. AUTO-04 requires CI to report test gap count and coverage metrics. The pipeline order per CONTEXT.md is: schemas -> stubs -> docs -> detect gaps -> generate tests -> coverage -> PR.
Output: Updated `.github/workflows/schema-check.yml` with two new steps and extended PR body
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-automated-test-generation-pipeline/25-CONTEXT.md
@.planning/phases/25-automated-test-generation-pipeline/25-RESEARCH.md
@.planning/phases/25-automated-test-generation-pipeline/25-01-SUMMARY.md
@.planning/phases/25-automated-test-generation-pipeline/25-02-SUMMARY.md

<interfaces>
<!-- Existing workflow structure (schema-check.yml) -->
<!-- Current step order:
  1. Checkout
  2. Setup R
  3. Install dependencies
  4. Ensure internal data
  5. Save old schemas for diff
  6. Download schemas
  7. Pretty-print schemas
  8. Compute schema hashes
  9. Diff schemas
  10. Clean up temporary diff artifacts
  11. Check for schema changes (id: schema_changes)
  12. Generate function stubs (id: stubs) — conditional on schema_changes
  13. Update documentation — conditional on schema_changes
  14. Calculate coverage (id: coverage) — conditional on schema_changes
  15. Check for all changes (id: changes)
  16. Workflow status summary
  17. Prepare PR body (id: pr_body)
  18. Create Pull Request
-->

<!-- New steps insert BETWEEN "Update documentation" (step 13) and "Calculate coverage" (step 14) -->
<!-- New PR body section inserts BETWEEN "Function Stub Generation" and "API Coverage" sections -->

From dev/detect_test_gaps.R (Plan 01 output variables):
- gaps_found: "true" or "false" string
- gaps_count: integer count of gaps

From dev/generate_tests.R (Plan 02 output variables):
- tests_generated: integer count
- tests_skipped: integer count (protected files)
- gaps_remaining: integer count
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add gap detection and test generation steps to schema-check.yml</name>
  <files>.github/workflows/schema-check.yml</files>
  <action>
Edit `.github/workflows/schema-check.yml` to insert two new steps and extend the PR body. All changes are additive — existing steps stay unchanged.

**Step 1: Insert two new workflow steps after "Update documentation" and before "Calculate coverage":**

After the "Update documentation" step (currently at line ~191) and before the "Calculate coverage" step, insert:

```yaml
      - name: Detect test gaps
        id: gaps
        if: steps.schema_changes.outputs.changed == 'true'
        continue-on-error: true
        run: |
          source("dev/detect_test_gaps.R")
        shell: Rscript {0}

      - name: Generate missing tests
        id: tests
        if: steps.schema_changes.outputs.changed == 'true' && steps.gaps.outputs.gaps_found == 'true'
        continue-on-error: true
        run: |
          source("dev/generate_tests.R")
        shell: Rscript {0}
```

Notes:
- Both steps use `continue-on-error: true` to prevent blocking the PR creation if test generation has issues
- The "Generate missing tests" step runs only when gaps were found AND schema changes exist
- Both steps use `shell: Rscript {0}` matching existing R step pattern
- The scripts' non-interactive entry points handle the actual execution

**Step 2: Extend the "Prepare PR body" step to include test gaps section:**

In the "Prepare PR body" step, after the "Function Stub Generation" section (after the parameter drift section, before the "API Coverage" section), add:

```bash
          # Add test gaps section
          cat >> pr_body.md << 'TESTGAPS'

          ### Test Gaps & Generation
          TESTGAPS
          echo "- **Gaps Detected:** ${{ steps.gaps.outputs.gaps_count || '0' }}" >> pr_body.md
          echo "- **Tests Generated:** ${{ steps.tests.outputs.tests_generated || '0' }}" >> pr_body.md
          echo "- **Tests Skipped (Protected):** ${{ steps.tests.outputs.tests_skipped || '0' }}" >> pr_body.md
          echo "- **Gaps Remaining:** ${{ steps.tests.outputs.gaps_remaining || '0' }}" >> pr_body.md
```

Insert this block BEFORE the line `# Add coverage section` / the `cat >> pr_body.md << 'COVERAGE'` block.

**Step 3: Ensure the commit message in Create Pull Request includes test files:**

The existing `peter-evans/create-pull-request@v6` step at the bottom auto-commits all changes in the working directory. The generated test files will be in `tests/testthat/` and `dev/test_manifest.json`. No changes needed to the commit step — it already picks up all unstaged changes. But update the commit message to mention tests:

Change:
```yaml
          commit-message: "chore: update API schemas and generate function stubs"
```
To:
```yaml
          commit-message: "chore: update API schemas, generate function stubs and tests"
```

Also update the PR title similarly:
```yaml
          title: "chore: API schema updates detected"
```
To:
```yaml
          title: "chore: API schema and test updates"
```

**Important constraints:**
- Do NOT change the workflow triggers (schedule + workflow_dispatch) — they stay as-is
- Do NOT change step ordering for existing steps — only insert new steps between documentation and coverage
- Do NOT add new R package dependencies — detect_test_gaps.R and generate_tests.R use packages already in the `extra-packages` list (cli, here, jsonlite, fs, stringr, purrr)
- The `glue` package used by generate_tests.R is a dependency of cli, so it's already available
  </action>
  <verify>
    <automated>python3 -c "import yaml; yaml.safe_load(open('.github/workflows/schema-check.yml'))" 2>/dev/null || "C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "cat(tryCatch({ yaml::read_yaml('.github/workflows/schema-check.yml'); 'YAML valid\n' }, error = function(e) paste('YAML invalid:', e$message, '\n')))"</automated>
  </verify>
  <done>
  - schema-check.yml is valid YAML
  - "Detect test gaps" step exists with id "gaps", conditional on schema_changes
  - "Generate missing tests" step exists with id "tests", conditional on gaps_found
  - Both new steps use continue-on-error: true
  - Both new steps are positioned after "Update documentation" and before "Calculate coverage"
  - PR body includes "Test Gaps & Generation" section with gaps_count, tests_generated, tests_skipped, gaps_remaining
  - Commit message and PR title mention tests
  - No existing steps modified or reordered
  </done>
</task>

</tasks>

<verification>
1. YAML is valid — parse without errors
2. Step order is correct: ... -> Update documentation -> Detect test gaps -> Generate missing tests -> Calculate coverage -> ...
3. New steps reference correct script paths (dev/detect_test_gaps.R, dev/generate_tests.R)
4. PR body template interpolates step output variables correctly
5. grep for "gaps" and "tests" step IDs confirms they exist
6. No R package dependencies added to extra-packages (all already present)
</verification>

<success_criteria>
- schema-check.yml is valid YAML with correct step ordering
- Pipeline follows CONTEXT.md order: schemas -> stubs -> docs -> detect gaps -> generate tests -> coverage -> PR
- PR body has test gap reporting section
- Generated tests committed in same PR as schemas and stubs
- Existing workflow behavior unchanged for runs without schema changes
</success_criteria>

<output>
After completion, create `.planning/phases/25-automated-test-generation-pipeline/25-03-SUMMARY.md`
</output>
