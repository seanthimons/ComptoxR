---
phase: 18-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/schema.R
  - .github/workflows/schema-check.yml
autonomous: true
must_haves:
  truths:
    - "Schema download functions timeout after configurable duration instead of hanging indefinitely"
    - "Workflow completes with warning status when schemas unavailable, not failure status"
    - "Expected 404s from brute-force path discovery are logged as info, not errors"
    - "Actual API failures (network errors, 500s) are clearly reported as warnings"
  artifacts:
    - path: "R/schema.R"
      provides: "Timeout-protected schema download functions with log-level differentiation"
      contains: "req_timeout"
    - path: ".github/workflows/schema-check.yml"
      provides: "Resilient CI workflow that degrades gracefully"
      contains: "continue-on-error"
  key_links:
    - from: "R/schema.R"
      to: "httr2::req_timeout"
      via: "All download paths use httr2 with configurable timeout"
      pattern: "req_timeout"
    - from: ".github/workflows/schema-check.yml"
      to: "R/schema.R"
      via: "Download step handles errors without failing job"
      pattern: "continue-on-error|tryCatch"
---

<objective>
Add timeout protection to all schema download paths and make the CI workflow resilient to API failures.

Purpose: Prevent hung API calls from blocking development and ensure the schema-check workflow degrades gracefully when APIs are unavailable.
Output: Updated R/schema.R with configurable timeouts and log-level differentiation; updated schema-check.yml that completes with warning status on download failures.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@R/schema.R
@.github/workflows/schema-check.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add configurable timeout protection and log-level differentiation to schema download functions</name>
  <files>R/schema.R</files>
  <action>
Replace all unprotected `download.file()` calls with httr2-based downloads that have configurable timeouts. Specifically:

1. **ct_schema() — Replace download.file() with httr2 (line 70-78):**
   - The `ping_url()` helper already uses httr2 with 5s timeout for HEAD checks, but the actual download on line 70 uses `download.file()` which has NO timeout.
   - Replace the `download.file()` call with an httr2 GET request using `req_timeout(timeout)` where timeout defaults to 30 seconds.
   - Add a `timeout` parameter to `ct_schema(timeout = 30)`.
   - Wrap the download in tryCatch. On timeout or network error, emit `cli::cli_alert_warning()` and continue to next endpoint (do not abort).
   - Also update the `ping_url()` inner function to use the same configurable timeout instead of hardcoded 5.

2. **chemi_schema() — Add timeout param and differentiate log levels (line 101-313):**
   - Add a `timeout` parameter: `chemi_schema(record = FALSE, timeout = 30)`.
   - The `attempt_download()` inner function already uses httr2 with `req_timeout(10)` — change this to use the configurable `timeout` parameter.
   - **Critical for REL-03:** In the brute-force URL candidate loop (lines 274-291), expected 404s should be SILENT (no log output at all — they are expected). Only log on success (`cli::cli_alert_info` — already done on line 288). Currently 404s return silently via `attempt_download()` which is correct, but the `ping_url()` helper at line 114 emits warnings for non-2xx — this ping_url is only used for the cim_component_info endpoint discovery call, not for brute-force. Verify this is the case and leave it as-is if so.
   - For the `cim_component_info` endpoint list fetch (lines 201-242): wrap in tryCatch with `req_timeout(timeout)`. On failure, emit `cli::cli_alert_warning("Could not reach chemi server ({server}): {conditionMessage(e)}")`. The existing try() blocks should be converted to tryCatch for consistency and better error messages.
   - After all servers are attempted, if ZERO schemas were downloaded across ALL servers, emit a single summary warning: `cli::cli_alert_warning("No chemi schemas could be downloaded from any server")`.

3. **cc_schema() — Replace download.file() with httr2 (line 327-384):**
   - Add a `timeout` parameter: `cc_schema(timeout = 30)`.
   - The `ping_url()` inner function exists (line 338) but is commented out on line 370. Uncomment the ping check and use it.
   - Replace `download.file()` (line 371-378) with an httr2 GET + `req_timeout(timeout)` + `writeBin(resp_body_raw(resp), destfile)`.
   - On failure, emit `cli::cli_alert_warning()` and return invisibly (do not abort).

4. **General pattern for all three functions:**
   - On success: `cli::cli_alert_success("Downloaded {endpoint} schema from {server}")`
   - On timeout: `cli::cli_alert_warning("Timeout downloading {endpoint} schema ({timeout}s limit)")`
   - On network error: `cli::cli_alert_warning("Network error downloading {endpoint}: {conditionMessage(e)}")`
   - On HTTP 5xx: `cli::cli_alert_warning("Server error ({status}) downloading {endpoint}")`
   - On HTTP 404 in brute-force: SILENT (no output)
   - Functions should NEVER abort/stop — always continue to next item

Do NOT change the function signatures beyond adding the `timeout` parameter. Do NOT change the return values. Preserve the `record` parameter behavior in chemi_schema.
  </action>
  <verify>
Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "devtools::document()"` to verify roxygen still parses.
Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "devtools::load_all(); ct_schema; chemi_schema; cc_schema"` to verify functions load without syntax errors and have the new timeout parameter (check with `formals(ct_schema)`).
  </verify>
  <done>
All three schema functions accept a configurable timeout parameter (default 30s). No download.file() calls remain — all downloads use httr2 with req_timeout(). Expected 404s in chemi_schema brute-force produce no log output. Real failures (timeout, network, 5xx) emit cli warnings. No function calls abort() or stop().
  </done>
</task>

<task type="auto">
  <name>Task 2: Make CI workflow resilient to schema download failures</name>
  <files>.github/workflows/schema-check.yml</files>
  <action>
Update the schema-check workflow so that download failures produce warnings instead of job failures.

1. **Add job-level timeout (safety net):**
   Add `timeout-minutes: 15` to the `check-schemas` job (line 13, after `runs-on`). This prevents the entire job from hanging if something unexpected blocks.

2. **Make "Download schemas" step resilient (lines 72-78):**
   - Add `continue-on-error: true` to the step.
   - Add an `id: download` to the step.
   - Wrap the R code in tryCatch so individual function failures don't prevent others from running:
   ```r
   pkgload::load_all()
   download_ok <- TRUE
   tryCatch(ct_schema(timeout = 60), error = function(e) {
     cli::cli_alert_warning("ct_schema failed: {conditionMessage(e)}")
     download_ok <<- FALSE
   })
   tryCatch(chemi_schema(timeout = 60), error = function(e) {
     cli::cli_alert_warning("chemi_schema failed: {conditionMessage(e)}")
     download_ok <<- FALSE
   })
   tryCatch(cc_schema(timeout = 60), error = function(e) {
     cli::cli_alert_warning("cc_schema failed: {conditionMessage(e)}")
     download_ok <<- FALSE
   })
   if (!download_ok) {
     cli::cli_alert_warning("One or more schema downloads failed - workflow will continue with available schemas")
   }
   ```
   Use timeout = 60 in CI (more generous than default 30 since CI runners can be slow).

3. **Make "Diff schemas" step resilient (lines 101-125):**
   - Add `continue-on-error: true` to this step.
   - The step already has an `id: diff`.

4. **Make "Compute schema hashes" step resilient (lines 80-99):**
   - Change the `cli::cli_abort("No schema files found!")` to `cli::cli_alert_warning("No schema files found - skipping hash computation")` followed by writing an empty hashes CSV and early return. This way the step doesn't fail when no schemas were downloaded.
   - Add `continue-on-error: true`.

5. **Add a workflow summary annotation step** after "Check for all changes" (before "Prepare PR body"):
   ```yaml
   - name: Workflow status summary
     if: always()
     run: |
       if [ "${{ steps.download.outcome }}" = "failure" ]; then
         echo "::warning::Schema download had failures - some schemas may be missing"
       fi
       if [ "${{ steps.diff.outcome }}" = "failure" ]; then
         echo "::warning::Schema diff encountered errors"
       fi
   ```
   This uses GitHub Actions `::warning::` annotation syntax to surface issues without failing the job.

6. **Guard downstream steps against missing schemas:**
   - The "Generate function stubs" step (line 139) already has `if: steps.schema_changes.outputs.changed == 'true'` which is fine.
   - The "Check for schema changes" step (line 127) uses `git diff --quiet schema/` which will just report no changes if the directory is empty — this is fine.

Do NOT change the overall workflow structure (job name, trigger conditions, PR creation logic). Only add resilience to download/diff/hash steps.
  </action>
  <verify>
Validate YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/schema-check.yml'))"` or equivalent.
Visually inspect that `continue-on-error: true` appears on download, hash, and diff steps.
Verify `timeout-minutes: 15` appears at job level.
  </verify>
  <done>
Workflow has job-level timeout (15 min). Download, hash, and diff steps all have continue-on-error: true. Download step wraps each schema function in tryCatch with 60s timeout. Hash step handles empty schema directory gracefully. Workflow summary step surfaces warnings via GitHub annotations. The workflow will complete (possibly with warnings) even when all APIs are unreachable.
  </done>
</task>

</tasks>

<verification>
1. R/schema.R: No `download.file()` calls remain. All three functions have `timeout` parameter. `formals()` confirms defaults.
2. R/schema.R: Functions load without errors after `devtools::load_all()`.
3. schema-check.yml: Valid YAML. Has `timeout-minutes`, `continue-on-error` on critical steps.
4. schema-check.yml: Download step uses tryCatch around each schema function with timeout=60.
5. No `stop()` or `abort()` calls in schema download paths (only warnings).
</verification>

<success_criteria>
- All schema download paths use httr2 with configurable timeout (no download.file remaining)
- CI workflow completes with warning status when APIs are down (never fails on download issues)
- chemi_schema brute-force 404s produce zero log noise
- Real failures (timeout, network, 5xx) produce clear cli warnings
- Workflow has job-level 15-minute timeout safety net
</success_criteria>

<output>
After completion, create `.planning/phases/18-reliability/18-01-SUMMARY.md`
</output>
