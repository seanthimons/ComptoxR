---
phase: 24-vcr-cassette-cleanup
plan: 02
type: execute
wave: 2
depends_on:
  - 24-01
files_modified:
  - tests/testthat/fixtures/
autonomous: true
requirements:
  - VCR-01
  - VCR-06

must_haves:
  truths:
    - "All 673 untracked .yml cassette files are deleted from tests/testthat/fixtures/"
    - "No committed cassettes contain actual API keys (all show <<<API_KEY>>> placeholder)"
    - "Security audit report confirms zero API key leaks in remaining cassettes"
  artifacts:
    - path: "tests/testthat/fixtures/"
      provides: "Clean cassette directory with only valid tracked cassettes"
  key_links:
    - from: "tests/testthat/helper-vcr.R"
      to: "tests/testthat/fixtures/"
      via: "delete_all_cassettes(dry_run = FALSE) for bulk deletion"
      pattern: "delete_all_cassettes"
---

<objective>
Delete all 673 untracked bad cassettes using the helper functions from Plan 01, then run a security audit on any remaining committed cassettes.

Purpose: Clean up the cassette directory to remove cassettes recorded with wrong parameters (from bad test generator), and verify no API keys are leaked in committed cassettes.

Output: Clean fixtures directory with only valid tracked cassettes, confirmed API-key safe.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-vcr-cassette-cleanup/24-01-SUMMARY.md

<interfaces>
<!-- Helper functions from Plan 01 -->
From tests/testthat/helper-vcr.R:
```r
list_cassettes()                        # Returns character vector of filenames
delete_all_cassettes(dry_run = TRUE)    # Deletes all cassettes (dry-run default)
delete_cassettes(pattern, dry_run = TRUE) # Deletes matching cassettes
check_cassette_safety(pattern = NULL)   # Scans for API key leaks
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete all 673 untracked bad cassettes</name>
  <files>tests/testthat/fixtures/</files>
  <action>
The 673 untracked .yml files in tests/testthat/fixtures/ are ALL from the bad generator run (LOCKED DECISION: delete all of them).

Strategy: Since these are untracked files (git doesn't track them), we need to identify and delete them. The user wants to dogfood the helper functions.

Steps:
1. Source `tests/testthat/helper-vcr.R` to load helper functions
2. Run `list_cassettes()` to get current count (should show 673+ cassettes)
3. Check `git status` of the fixtures directory to identify which cassettes are tracked vs untracked
4. Use a targeted approach: get list of all cassette files, filter to only untracked ones (using `git ls-files --others --exclude-standard tests/testthat/fixtures/`), then delete those
5. If ALL cassettes are untracked (likely since git status shows 673 as `??`), use `delete_all_cassettes(dry_run = FALSE)` directly
6. If some are tracked, use `fs::file_delete()` on just the untracked file list
7. Verify deletion: `list_cassettes()` should return only tracked cassettes (or empty if all were untracked)

Important: The user decision says "Use the newly built helper functions to perform the deletion (dogfooding the tools)." Use delete_all_cassettes or delete_cassettes as appropriate.

Commit the deletion as a separate commit from the helper functions (LOCKED DECISION: separate commits).
  </action>
  <verify>
    <automated>git ls-files --others --exclude-standard tests/testthat/fixtures/ | wc -l</automated>
  </verify>
  <done>Zero untracked .yml files remain in tests/testthat/fixtures/. The 673 bad cassettes are deleted. Any tracked cassettes remain intact.</done>
</task>

<task type="auto">
  <name>Task 2: Run security audit on remaining cassettes</name>
  <files>tests/testthat/fixtures/</files>
  <action>
Run `check_cassette_safety()` on all remaining committed cassettes to verify VCR-06.

Steps:
1. Source `tests/testthat/helper-vcr.R`
2. Run `check_cassette_safety()` with no arguments (scans all remaining cassettes)
3. If issues are found:
   - Document which cassettes have leaked API keys
   - Report the findings (do NOT auto-fix â€” LOCKED DECISION: report-only mode)
   - Note in the SUMMARY which cassettes need attention
4. If no issues found: confirm all cassettes are API-key safe
5. Also check: if there are no remaining cassettes at all (all were untracked), document that the security audit passed vacuously (no cassettes to scan)

Additionally, verify R CMD check still passes after cassette deletion:
- Run `"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "devtools::check(error_on = 'error')"` or at minimum check that the package loads
  </action>
  <verify>
    <automated>"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('tests/testthat/helper-vcr.R'); issues <- check_cassette_safety(); cat('Issues found:', length(issues), '\n')"</automated>
  </verify>
  <done>Security audit completed. All committed cassettes (if any) show <<<API_KEY>>> placeholder instead of actual keys. Audit results documented.</done>
</task>

</tasks>

<verification>
- `git ls-files --others --exclude-standard tests/testthat/fixtures/ | wc -l` returns 0
- check_cassette_safety() reports zero issues on remaining cassettes
- No actual API keys visible in any cassette file
</verification>

<success_criteria>
All 673 untracked bad cassettes are deleted. Security audit confirms zero API key leaks in any remaining committed cassettes.
</success_criteria>

<output>
After completion, create `.planning/phases/24-vcr-cassette-cleanup/24-02-SUMMARY.md`
</output>
