---
phase: 24-vcr-cassette-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/testthat/helper-vcr.R
autonomous: true
requirements:
  - VCR-02
  - VCR-03
  - VCR-04
  - VCR-05

must_haves:
  truths:
    - "delete_all_cassettes() lists all cassettes in dry-run mode without deleting"
    - "delete_all_cassettes(dry_run = FALSE) actually deletes all cassette files"
    - "delete_cassettes(pattern) matches cassettes by regex or glob and respects dry-run default"
    - "list_cassettes() returns a character vector of cassette filenames"
    - "check_cassette_safety() scans cassettes for leaked API keys and auth headers"
    - "check_cassette_safety() reports issues without auto-fixing"
  artifacts:
    - path: "tests/testthat/helper-vcr.R"
      provides: "VCR helper functions for cassette management"
      contains: "delete_all_cassettes|delete_cassettes|list_cassettes|check_cassette_safety"
  key_links:
    - from: "tests/testthat/helper-vcr.R"
      to: "tests/testthat/fixtures/"
      via: "fs::dir_ls for cassette discovery"
      pattern: "dir_ls.*fixtures"
---

<objective>
Implement VCR cassette management helper functions in tests/testthat/helper-vcr.R.

Purpose: Provide safe, reusable tools for cassette lifecycle management (listing, deleting, auditing) that will be used by Plan 02 to clean up 673 bad cassettes and by ongoing development.

Output: Four helper functions added to the existing helper-vcr.R file.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Existing helper-vcr.R content (all 12 lines) -->
From tests/testthat/helper-vcr.R:
```r
library(vcr)

vcr_dir <- "../testthat/fixtures"
if (!dir.exists(vcr_dir)) dir.create(vcr_dir, recursive = TRUE)

vcr::vcr_configure(
  dir = vcr_dir,
  filter_sensitive_data = list(
    "<<<API_KEY>>>" = Sys.getenv("ctx_api_key")
  )
)
```

<!-- Dependencies already available in project -->
# fs - cross-platform file operations
# cli - user-facing messages
# yaml - YAML parsing (for security scanning)
# here - project root detection
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cassette management helpers to helper-vcr.R</name>
  <files>tests/testthat/helper-vcr.R</files>
  <action>
Append four helper functions to the existing tests/testthat/helper-vcr.R file, AFTER the existing vcr_configure block. Do NOT modify the existing configuration code.

**1. `list_cassettes()`** (VCR-04)
- Returns a simple character vector of cassette filenames (no paths, no metadata)
- Uses `fs::dir_ls()` with glob `"*.yml"` on the fixtures directory
- Returns `fs::path_file()` of results
- Use `here::here("tests/testthat/fixtures")` for the cassette directory path

**2. `delete_all_cassettes(dry_run = TRUE)`** (VCR-02)
- Default is dry-run mode (LOCKED DECISION)
- In dry-run: use `cli::cli_alert_info()` to show count of cassettes that WOULD be deleted, print `cli::cli_alert_warning("Set dry_run = FALSE to actually delete")`
- When `dry_run = FALSE`: use `fs::file_delete()` to remove all .yml files, report count with `cli::cli_alert_success()`
- Returns `invisible(cassettes)` (the file paths)

**3. `delete_cassettes(pattern, dry_run = TRUE)`** (VCR-03)
- Accepts a pattern string. If pattern contains `*`, treat as glob via `fs::dir_ls(glob = pattern)`. Otherwise treat as regex via `fs::dir_ls(regexp = pattern)`.
- Same dry-run behavior as `delete_all_cassettes()`
- If no cassettes match, warn with `cli::cli_alert_warning("No cassettes match pattern: {pattern}")` and return `invisible(character(0))`
- In dry-run mode, additionally list matching filenames using `cli::cli_bullets()`

**4. `check_cassette_safety(pattern = NULL)`** (VCR-05)
- If pattern is NULL, scan ALL cassettes. If pattern provided, filter cassettes by regex.
- For each cassette file, read lines with `readLines(file, warn = FALSE)`
- Check for:
  - `x-api-key:` headers that do NOT contain `<<<API_KEY>>>` (unfiltered API keys)
  - `Authorization:` headers with `Bearer` followed by actual tokens (not placeholders)
  - Any line matching the current `Sys.getenv("ctx_api_key")` value (if non-empty)
- Build a named list of issues: `list(filename = "issue description")`
- Report mode only (LOCKED DECISION): use `cli::cli_alert_danger()` for issues found, `cli::cli_alert_success()` if clean
- Use `purrr::iwalk()` to iterate over issues for detailed reporting
- Return `invisible(issues)`
  </action>
  <verify>
    <automated>"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('tests/testthat/helper-vcr.R'); cat('list_cassettes:', is.function(list_cassettes), '\n'); cat('delete_all_cassettes:', is.function(delete_all_cassettes), '\n'); cat('delete_cassettes:', is.function(delete_cassettes), '\n'); cat('check_cassette_safety:', is.function(check_cassette_safety), '\n')"</automated>
  </verify>
  <done>All four helper functions exist in helper-vcr.R, are syntactically valid, and can be sourced without error. delete_all_cassettes and delete_cassettes default to dry_run=TRUE. check_cassette_safety is report-only with no auto-fix behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Verify helper functions work correctly with dry-run mode</name>
  <files>tests/testthat/helper-vcr.R</files>
  <action>
Run a quick validation of the helper functions by sourcing the file and testing key behaviors:

1. Source helper-vcr.R
2. Call `list_cassettes()` and verify it returns a character vector
3. Call `delete_all_cassettes()` (dry-run by default) and verify it does NOT delete any files — count fixtures before and after must be equal
4. Call `delete_cassettes("ct_chemical")` (dry-run by default) and verify no files deleted
5. Call `check_cassette_safety()` and verify it returns a list (may be empty if no cassettes have issues)

If any function errors out, fix it in helper-vcr.R. This is a validation step, not a test file creation step — do NOT create a new test file.
  </action>
  <verify>
    <automated>"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('tests/testthat/helper-vcr.R'); stopifnot(is.character(list_cassettes())); before <- length(list_cassettes()); delete_all_cassettes(); stopifnot(length(list_cassettes()) == before); cat('All helpers validated OK\n')"</automated>
  </verify>
  <done>All four helper functions execute without error. Dry-run mode confirmed to not delete files. list_cassettes returns character vector. check_cassette_safety returns list.</done>
</task>

</tasks>

<verification>
- helper-vcr.R contains all four functions: delete_all_cassettes, delete_cassettes, list_cassettes, check_cassette_safety
- Existing vcr_configure block is preserved unchanged
- All functions can be sourced without error
- Dry-run mode prevents accidental deletion
- check_cassette_safety is report-only (no auto-fix)
</verification>

<success_criteria>
Four cassette management helper functions are implemented in tests/testthat/helper-vcr.R with dry-run defaults for destructive operations and report-only mode for security auditing.
</success_criteria>

<output>
After completion, create `.planning/phases/24-vcr-cassette-cleanup/24-01-SUMMARY.md`
</output>
