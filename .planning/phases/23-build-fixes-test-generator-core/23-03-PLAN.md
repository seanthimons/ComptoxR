---
phase: 23-build-fixes-test-generator-core
plan: 03
type: execute
wave: 2
depends_on:
  - 23-01
files_modified:
  - dev/generate_tests.R
  - tests/testthat/test-test-generator.R
autonomous: true
requirements:
  - TGEN-01
  - TGEN-02
  - TGEN-03
  - TGEN-04
  - TGEN-05

must_haves:
  truths:
    - "Test generator reads actual parameter names from function signatures using formals()"
    - "Test generator reads tidy flag from generic_request/generic_chemi_request calls in function body"
    - "Test generator produces parameterless test calls for static endpoints (no-param functions)"
    - "Test generator produces correct test values for path_params (per parameter name mapping)"
    - "Generated tests use unique cassette names: function_single, function_batch, function_error"
    - "Generated tests assert tibble for tidy=TRUE and list for tidy=FALSE"
  artifacts:
    - path: "dev/generate_tests.R"
      provides: "Metadata-aware test generator producing correct tests per function"
      exports: ["generate_test_file", "extract_function_formals", "extract_tidy_flag", "get_test_value_for_param", "get_batch_test_values"]
    - path: "tests/testthat/test-test-generator.R"
      provides: "Unit tests for all 5 TGEN requirements"
  key_links:
    - from: "dev/generate_tests.R"
      to: "R/*.R"
      via: "Reads function source files to extract formals and tidy flags"
      pattern: "parse.*file|readLines|formals"
    - from: "dev/generate_tests.R"
      to: "tests/testthat/test-*.R"
      via: "Generates test files with VCR cassettes"
      pattern: "writeLines.*test_content"
---

<objective>
Build the core test generator that reads actual function metadata and produces correct, type-aware tests for every API wrapper function.

Purpose: The current test generator blindly passes DTXSIDs to all parameters and assumes all functions return tibbles, causing 834+ test failures. The new generator must read actual function signatures with formals(), extract the tidy flag from function bodies, map parameter names to appropriate test values, handle static endpoints and path_params, and use unique cassette names per variant.

Output: dev/generate_tests.R — a complete test generator script with unit tests proving all 5 TGEN requirements.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-build-fixes-test-generator-core/23-CONTEXT.md
@.planning/phases/23-build-fixes-test-generator-core/23-RESEARCH.md
@R/z_generic_request.R
@tests/testthat/helper-vcr.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build metadata-aware test generator (TGEN-01 through TGEN-05)</name>
  <files>dev/generate_tests.R</files>
  <action>
Create `dev/generate_tests.R` — the core test generation script. It must contain the following functions:

**1. extract_function_formals(file_path, function_name)** (TGEN-01)
- Parse the R source file using `parse(file = file_path)`
- Find the function assignment matching `function_name`
- Return `formals()` of that function as a named list
- Include regex-based fallback for files that don't parse cleanly
- Filter out framework params: `tidy`, `verbose`, `...`

**2. extract_tidy_flag(file_path)** (TGEN-02)
- Read function body lines
- Search for `generic_request(`, `generic_chemi_request(`, or `generic_cc_request(` calls
- Extract the `tidy = TRUE/FALSE` value from those calls
- If `tidy` param is not found in the call, check if the function passes `tidy` through from its own formals (i.e., `tidy = tidy`)
- Default to TRUE if no tidy parameter found anywhere

**3. get_test_value_for_param(param_name, param_examples = NULL)** (TGEN-01, TGEN-04)
- Priority 1: If `param_examples` provided (from roxygen @examples), use first example value
- Priority 2: Exact match against mapping table:
  - query/dtxsid -> "DTXSID7020182"
  - dtxcid -> "DTXCID30182"
  - casrn/cas -> "80-05-7"
  - smiles -> "c1ccccc1"
  - formula -> "C15H14O"
  - mass -> 210.0
  - limit/top/count/size -> 100L
  - offset/skip/start/page -> 0L (page -> 1L)
  - search_type -> "equals"
  - list_name -> "PRODWATER"
  - aeid -> 42L
  - model -> "RF"
  - tidy/verbose -> TRUE/FALSE
- Priority 3: Pattern matching (grepl on param name for numeric/boolean indicators)
- Priority 4: Canonical fallback "DTXSID7020182"

**4. get_batch_test_values(param_name)** (TGEN-01)
- For DTXSID-type: c("DTXSID7020182", "DTXSID3060245")
- For SMILES: c("c1ccccc1", "CC(C)O")
- For CAS: c("80-05-7", "67-64-1")
- For integers: c(value, value + 10L)
- Default: 2-item vector (per CONTEXT.md: 2-3 items)

**5. generate_test_file(function_name, function_file, output_dir)** (TGEN-03, TGEN-05)
- Call extract_function_formals() and extract_tidy_flag()
- Determine return assertion: `expect_s3_class(result, "tbl_df")` for tidy=TRUE, `expect_type(result, "list")` for tidy=FALSE
- Handle no-parameter functions (TGEN-03): generate `function_name()` call with no args for single test, skip batch test
- Handle path_params functions (TGEN-04): map each path_params value to appropriate type
- Build 3 test variants with unique cassette names (TGEN-05):
  - `{function_name}_single` — one valid input
  - `{function_name}_batch` — 2-3 inputs (skip if no-param or batch_limit=1)
  - `{function_name}_error` — missing required params, no VCR cassette
- Use glue for template interpolation
- Write to `tests/testthat/test-{function_name}.R`

**6. Main entry point**: When sourced as a script, scan R/ for ct_*, chemi_*, cc_* functions, detect test gaps (functions without test files), generate tests for gaps. Print summary.

Per CONTEXT.md decisions:
- Smoke tests + type checks only (no value assertions)
- Test variants: single, batch, error (no API error variants — deferred to Phase 24)
- Priority 1: roxygen @examples for values, Priority 2: mapping table
- Canonical DTXSID: DTXSID7020182 (Bisphenol A)
  </action>
  <verify>
    <automated>"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('dev/generate_tests.R'); cat('generate_tests.R sources cleanly\n'); stopifnot(is.function(generate_test_file)); stopifnot(is.function(extract_function_formals)); stopifnot(is.function(extract_tidy_flag)); cat('All functions exist\n')"</automated>
  </verify>
  <done>dev/generate_tests.R contains all 5 core functions, sources without error, handles all function types</done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for test generator (TGEN-01 through TGEN-05)</name>
  <files>tests/testthat/test-test-generator.R</files>
  <action>
Create `tests/testthat/test-test-generator.R` with comprehensive unit tests covering all 5 TGEN requirements:

**TGEN-01 tests (parameter extraction and type mapping):**
- Test `extract_function_formals()` against a known function file (e.g., R/ct_hazard.R or any stable ct_* file). Verify it returns expected parameter names.
- Test `get_test_value_for_param("dtxsid")` returns "DTXSID7020182"
- Test `get_test_value_for_param("limit")` returns an integer
- Test `get_test_value_for_param("formula")` returns a string like "C15H14O"
- Test `get_test_value_for_param("unknown_param_xyz")` returns the canonical DTXSID fallback

**TGEN-02 tests (tidy flag extraction):**
- Test `extract_tidy_flag()` against a known tidy=TRUE function file
- Test `extract_tidy_flag()` against a known tidy=FALSE function file (find one by grepping R/ for `tidy = FALSE`)
- Test default behavior returns TRUE when tidy param not found

**TGEN-03 tests (no-parameter functions):**
- Test `generate_test_file()` with a static endpoint function that has no params (e.g., ct_lists_all or similar). Generated test should call `function_name()` with no arguments. Generated test should NOT have a batch variant.

**TGEN-04 tests (path_params handling):**
- Test `get_test_value_for_param()` for path-related params like "start", "end", "property_name"
- Test that generated test code for a path_params function includes appropriate values

**TGEN-05 tests (unique cassette names):**
- Test that `generate_test_file()` output contains cassette names matching `{function_name}_single`, `{function_name}_batch`, `{function_name}_error`
- Test that all 3 cassette names are unique (no duplicates)

The test file must source dev/generate_tests.R at the top. Use `withr::with_tempdir()` for tests that generate output files (write to temp dir, read back, verify content).
  </action>
  <verify>
    <automated>"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_file('tests/testthat/test-test-generator.R')"</automated>
  </verify>
  <done>All TGEN unit tests pass, covering parameter extraction, tidy flag reading, no-param handling, path_params, and cassette naming</done>
</task>

</tasks>

<verification>
After both tasks:
1. `testthat::test_file("tests/testthat/test-test-generator.R")` — all tests pass
2. `source("dev/generate_tests.R")` — script sources without error
3. All 5 TGEN requirements have at least one passing test
</verification>

<success_criteria>
- generate_test_file() produces correct test code for tidy=TRUE functions (asserts tibble)
- generate_test_file() produces correct test code for tidy=FALSE functions (asserts list)
- generate_test_file() handles zero-parameter static endpoints
- Parameter mapping covers DTXSID, CAS, SMILES, formula, integers, booleans
- Each generated test file has unique cassette names per variant
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-build-fixes-test-generator-core/23-03-SUMMARY.md`
</output>
