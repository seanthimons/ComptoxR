---
phase: 23-build-fixes-test-generator-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - DESCRIPTION
  - LICENSE
  - LICENSE.md
  - R/extract_mol_formula.R
  - R/z_generic_request.R
  - R/ct_chemical_msready_by_mass.R
  - R/ct_chemical_msready_search_by_mass_bulk.R
  - NAMESPACE
autonomous: true
requirements:
  - BUILD-02
  - BUILD-03
  - BUILD-04
  - BUILD-05
  - BUILD-07
  - BUILD-08

must_haves:
  truths:
    - "DESCRIPTION has valid MIT + file LICENSE license specification"
    - "DESCRIPTION Imports contains only packages actually used by R/ code"
    - "No non-ASCII characters exist in any R/ source file"
    - "No import collisions between jsonlite::flatten and purrr::flatten"
    - "httr2 helper functions for resp_is_transient/resp_status_class exist or httr2 version is bumped"
    - "No partial argument match warnings from body to body_type"
  artifacts:
    - path: "DESCRIPTION"
      provides: "Valid license, cleaned imports"
      contains: "License: MIT + file LICENSE"
    - path: "LICENSE"
      provides: "MIT license file"
    - path: "R/extract_mol_formula.R"
      provides: "Non-ASCII characters replaced with unicode escapes"
    - path: "R/z_generic_request.R"
      provides: "httr2 compatibility resolved"
  key_links:
    - from: "DESCRIPTION"
      to: "NAMESPACE"
      via: "devtools::document() regenerates NAMESPACE from Imports"
      pattern: "importFrom"
---

<objective>
Merge the open schema PR and fix all non-generator BUILD issues so the package infrastructure is clean before touching the stub generator.

Purpose: Per user decision, non-generator BUILD fixes come first. These are independent of each other and the generator pipeline — fixing them first gives a stable base for generator work.

Output: DESCRIPTION with valid license and clean imports, non-ASCII chars fixed, httr2 compatibility resolved, partial match fixed.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-build-fixes-test-generator-core/23-CONTEXT.md
@.planning/phases/23-build-fixes-test-generator-core/23-RESEARCH.md
@DESCRIPTION
@R/extract_mol_formula.R
@R/z_generic_request.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge open PR and fix license + imports (BUILD-02, BUILD-07)</name>
  <files>DESCRIPTION, LICENSE, LICENSE.md, NAMESPACE</files>
  <action>
1. Merge PR #113 (schema updates) into the integration branch using `gh pr merge 113 --merge` or manually merge.

2. Fix BUILD-07 (License): Replace the invalid placeholder `License: \`use_mit_license()\`, \`use_gpl3_license()\`` in DESCRIPTION with `License: MIT + file LICENSE`. Create a LICENSE file with the MIT license text (year: 2026, copyright holder: Sean Thimons). Create LICENSE.md with the full MIT license text. Per user decision: use MIT + file LICENSE.

3. Fix BUILD-02 (Imports cleanup):
   - Remove `ggplot2` from Imports (not used in R/ code — verify with grep first)
   - Remove `janitor` from Imports (not used in R/ code — verify with grep first)
   - Remove `testthat` from Imports (it belongs in Suggests only, already there via Config/testthat)
   - Add `testthat` to Suggests if not already present
   - Verify `devtools`, `magick`, `usethis` are NOT in Imports (they shouldn't be)
   - Keep `scales` only if used — check with grep

4. Run `devtools::document()` to regenerate NAMESPACE from updated DESCRIPTION.
  </action>
  <verify>
    <automated>"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "desc <- read.dcf('DESCRIPTION'); stopifnot(grepl('MIT', desc[,'License'])); cat('License OK\n'); imports <- strsplit(desc[,'Imports'], ',')[[1]]; imports <- trimws(imports); stopifnot(!any(c('ggplot2', 'janitor') %in% imports)); cat('Imports OK\n')"</automated>
  </verify>
  <done>DESCRIPTION has "License: MIT + file LICENSE", LICENSE file exists, ggplot2/janitor removed from Imports, testthat only in Suggests/Config</done>
</task>

<task type="auto">
  <name>Task 2: Fix non-ASCII characters and import collision (BUILD-03, BUILD-04)</name>
  <files>R/extract_mol_formula.R, NAMESPACE</files>
  <action>
1. Fix BUILD-03 (Non-ASCII characters): Open R/extract_mol_formula.R and find all non-ASCII characters (likely middle dot, en dash, or other Unicode symbols in regex patterns or string literals). Replace each with the appropriate `\uxxxx` escape sequence. Use `tools::showNonASCII(readLines("R/extract_mol_formula.R"))` to locate them. Common replacements:
   - Middle dot (·) → `\u00b7`
   - En dash (–) → `\u2013`
   - Em dash (—) → `\u2014`
   - Degree sign (°) → `\u00b0`

2. Fix BUILD-04 (Import collision): Check if both `jsonlite::flatten` and `purrr::flatten` are imported in NAMESPACE. If so, ensure code uses explicit `jsonlite::flatten()` or `purrr::list_flatten()` calls (purrr::flatten is deprecated in favor of list_flatten). Remove any bare `@importFrom purrr flatten` or `@importFrom jsonlite flatten` if the code uses explicit namespacing. Search R/ for bare `flatten(` calls and prefix them appropriately.
  </action>
  <verify>
    <automated>"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "lines <- readLines('R/extract_mol_formula.R'); non_ascii <- grep('[^\x01-\x7f]', lines); if(length(non_ascii) > 0) stop(paste('Non-ASCII on lines:', paste(non_ascii, collapse=', '))); cat('No non-ASCII characters found\n')"</automated>
  </verify>
  <done>R/extract_mol_formula.R contains only ASCII characters with \uxxxx escapes for Unicode, no flatten import collision in NAMESPACE</done>
</task>

<task type="auto">
  <name>Task 3: Fix httr2 compatibility and partial argument match (BUILD-05, BUILD-08)</name>
  <files>R/z_generic_request.R, R/ct_chemical_msready_by_mass.R, R/ct_chemical_msready_search_by_mass_bulk.R</files>
  <action>
1. Fix BUILD-05 (httr2 compatibility): Check R/z_generic_request.R for calls to `httr2::resp_is_transient` and `httr2::resp_status_class`. These functions may not exist in the installed httr2 version. Resolution options (Claude's discretion per CONTEXT.md):
   - Option A: If the codebase already has a custom `is_transient_error()` helper (research says line ~99 of z_generic_request.R), use that instead of `httr2::resp_is_transient`.
   - Option B: Replace `resp_status_class` calls with equivalent logic using `httr2::resp_status()` (e.g., `floor(resp_status(resp) / 100)` gives the class).
   - Option C: If httr2 1.1.0+ has these functions, bump minimum version in DESCRIPTION.
   Check which option is cleanest and implement.

2. Fix BUILD-08 (Partial argument match): In `R/ct_chemical_msready_by_mass.R` and `R/ct_chemical_msready_search_by_mass_bulk.R`, find calls where `body` is used as a shortened argument name for `body_type`. Replace with the full parameter name `body_type`. Search for pattern: `body =` in these files (excluding `req_body` or `body_type`).
  </action>
  <verify>
    <automated>"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "tryCatch({for(f in c('R/z_generic_request.R','R/ct_chemical_msready_by_mass.R','R/ct_chemical_msready_search_by_mass_bulk.R')){parse(file=f)}; cat('All files parse OK\n')}, error=function(e) stop(e$message))"</automated>
  </verify>
  <done>No references to missing httr2 functions, no partial argument matches for body/body_type in the two msready files</done>
</task>

</tasks>

<verification>
After all 3 tasks:
1. All R/ files parse without errors
2. DESCRIPTION has valid license and clean imports
3. `devtools::document()` runs without errors
4. No non-ASCII characters in R/ source files
</verification>

<success_criteria>
- DESCRIPTION License field reads "MIT + file LICENSE"
- LICENSE file exists at package root
- ggplot2, janitor removed from Imports
- testthat only in Suggests
- R/extract_mol_formula.R has zero non-ASCII characters
- No import collision between jsonlite::flatten and purrr::flatten
- httr2::resp_is_transient and resp_status_class calls resolved
- body partial match fixed in msready files
</success_criteria>

<output>
After completion, create `.planning/phases/23-build-fixes-test-generator-core/23-01-SUMMARY.md`
</output>
