---
phase: 23-build-fixes-test-generator-core
plan: 02
type: execute
wave: 2
depends_on:
  - 23-01
files_modified:
  - dev/endpoint_eval/07_stub_generation.R
  - dev/endpoint_eval/01_schema_resolution.R
  - dev/endpoint_eval/08_drift_detection.R
  - dev/generate_stubs.R
  - dev/diff_schemas.R
  - .github/workflows/schema-check.yml
  - tests/testthat/test-stub-generator.R
  - tests/testthat/test-drift-detection.R
autonomous: true
requirements:
  - BUILD-01
  - BUILD-06

must_haves:
  truths:
    - "build_function_stub() produces valid R syntax for all endpoint types including chemi options with reserved words"
    - "Generated roxygen @param tags match actual function parameter names"
    - "select_schema_files() is in 01_schema_resolution.R and used by both diff_schemas.R and generate_stubs.R"
    - "detect_parameter_drift() reports added/removed params without modifying existing files"
    - "Diff reporter and stub generator operate on the same canonical schema per domain"
  artifacts:
    - path: "dev/endpoint_eval/07_stub_generation.R"
      provides: "Fixed stub generator producing valid R syntax and matching roxygen"
    - path: "dev/endpoint_eval/01_schema_resolution.R"
      provides: "Shared select_schema_files() used by both diff and stub systems"
      exports: ["select_schema_files"]
    - path: "dev/endpoint_eval/08_drift_detection.R"
      provides: "Parameter drift detection between schema and codebase"
      exports: ["detect_parameter_drift"]
    - path: "tests/testthat/test-stub-generator.R"
      provides: "Unit tests for stub generator syntax correctness"
    - path: "tests/testthat/test-drift-detection.R"
      provides: "Unit tests for drift detection"
  key_links:
    - from: "dev/generate_stubs.R"
      to: "dev/endpoint_eval/01_schema_resolution.R"
      via: "source() call"
      pattern: "source.*01_schema_resolution"
    - from: "dev/diff_schemas.R"
      to: "dev/endpoint_eval/01_schema_resolution.R"
      via: "source() call for select_schema_files"
      pattern: "source.*01_schema_resolution"
    - from: "dev/generate_stubs.R"
      to: "dev/endpoint_eval/08_drift_detection.R"
      via: "source() call"
      pattern: "source.*08_drift_detection"
---

<objective>
Fix the stub generator syntax bugs (BUILD-01, BUILD-06) and align the schema automation pipeline (Items 2 and 3 from SCHEMA_AUTOMATION_PLAN.md).

Purpose: The stub generator produces invalid R syntax ("RF" <- model = "RF") and mismatched roxygen docs. These must be fixed before regenerating all stubs. Schema automation alignment ensures the diff reporter and stub generator agree on which schemas to process, and drift detection catches API parameter changes in existing functions.

Output: Fixed stub generator, shared schema selection, drift detection function, all with unit tests.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-build-fixes-test-generator-core/23-CONTEXT.md
@.planning/phases/23-build-fixes-test-generator-core/23-RESEARCH.md
@SCHEMA_AUTOMATION_PLAN.md
@dev/endpoint_eval/07_stub_generation.R
@dev/endpoint_eval/01_schema_resolution.R
@dev/generate_stubs.R
@dev/diff_schemas.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix stub generator syntax bugs and roxygen mismatch (BUILD-01, BUILD-06)</name>
  <files>dev/endpoint_eval/07_stub_generation.R, tests/testthat/test-stub-generator.R</files>
  <action>
1. Read dev/endpoint_eval/07_stub_generation.R and find the `build_function_stub()` function (or equivalent that builds the R code string).

2. Fix BUILD-01 — Identify the glue template logic that produces invalid syntax like `"RF" <- model = "RF"`. This likely occurs in the chemi options list construction where parameter defaults are injected. The fix should ensure:
   - Default values with reserved words or strings are properly quoted in the generated code
   - The `if (!is.null(param)) options$param <- param` pattern is generated correctly
   - No `<-` operator appears inside function argument lists
   - Add `parse(text = generated_code)` validation before writing stubs (catch syntax errors at generation time)

3. Fix BUILD-06 — Find where roxygen `@param` tags are generated. Ensure they are derived from the actual function signature (the `formals` that the generator creates), NOT from raw schema parameter descriptions. The @param list must exactly match the function's formal arguments.

4. Create tests/testthat/test-stub-generator.R with unit tests:
   - Test that build_function_stub() produces parseable R code for a chemi endpoint with string-default options (the "RF" case)
   - Test that build_function_stub() produces parseable R code for a CT endpoint with path params
   - Test that generated roxygen @param names match function formal names
   - Test that generated code with reserved word defaults (like TRUE, FALSE, NULL) is valid syntax

Note: The test file must source the stub generation utilities to test them directly. Use `source(here::here("dev/endpoint_eval/07_stub_generation.R"))` pattern (and its dependencies).
  </action>
  <verify>
    <automated>"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_file('tests/testthat/test-stub-generator.R')"</automated>
  </verify>
  <done>build_function_stub() generates valid R syntax for all endpoint types, @param tags match formals, unit tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Schema selection alignment + drift detection (Items 2 & 3)</name>
  <files>dev/endpoint_eval/01_schema_resolution.R, dev/endpoint_eval/08_drift_detection.R, dev/generate_stubs.R, dev/diff_schemas.R, .github/workflows/schema-check.yml, tests/testthat/test-drift-detection.R</files>
  <action>
**Item 2 — Schema selection alignment (Approach A per CONTEXT.md):**

1. Check if `select_schema_files()` is already defined in `dev/endpoint_eval/01_schema_resolution.R` or in `dev/generate_stubs.R`. Move it to `01_schema_resolution.R` if not already there.

2. Update `dev/generate_stubs.R` to source `select_schema_files()` from `01_schema_resolution.R` (it already sources this file, so just remove the local definition if one exists).

3. Update `dev/diff_schemas.R`:
   - Add `source(here::here("dev/endpoint_eval/01_schema_resolution.R"))` at the top
   - Modify `diff_schemas()` to accept `stage_priority` and `exclude_pattern` parameters
   - When `stage_priority` is non-NULL, call `select_schema_files()` on both old_dir and new_dir to filter to canonical schemas before diffing
   - Update `.github/workflows/schema-check.yml` diff step to pass `stage_priority = c("prod", "staging", "dev")` and `exclude_pattern = "ui"`

**Item 3 — Drift detection (report-only per CONTEXT.md):**

4. Create `dev/endpoint_eval/08_drift_detection.R` with:
   - `detect_parameter_drift(endpoints, usage_summary, pkg_dir = "R")` — compares schema params vs function formals
   - `extract_function_params(file_path, function_name)` — parse-based with regex fallback
   - `FRAMEWORK_PARAMS` constant: `c("tidy", "verbose", "...", ".verbose", ".tidy")`
   - Returns a tibble with columns: endpoint, file, function_name, drift_type, param_name, schema_value, code_value
   - Does NOT modify any existing files (report-only)

5. Update `dev/generate_stubs.R`:
   - Source `08_drift_detection.R`
   - After `find_endpoint_usages_base()`, call `detect_parameter_drift()` for endpoints with n_hits > 0
   - Write drift results to stdout/file for CI consumption
   - Add `drift_count` and `drift_endpoints` to GITHUB_OUTPUT

6. Update `.github/workflows/schema-check.yml`:
   - Read drift report and include in PR body as "Parameter Drift Detected" section

7. Create `tests/testthat/test-drift-detection.R`:
   - Test that `extract_function_params()` correctly extracts formals from a known R file
   - Test that FRAMEWORK_PARAMS are excluded from drift results
   - Test that added params are detected (mock a schema param not in function formals)
   - Test that report is a tibble with expected columns
  </action>
  <verify>
    <automated>"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "testthat::test_file('tests/testthat/test-drift-detection.R')"</automated>
  </verify>
  <done>select_schema_files() is shared between diff_schemas.R and generate_stubs.R, detect_parameter_drift() reports drifts without modifying files, CI workflow updated, all tests pass</done>
</task>

</tasks>

<verification>
After both tasks:
1. `testthat::test_file("tests/testthat/test-stub-generator.R")` passes
2. `testthat::test_file("tests/testthat/test-drift-detection.R")` passes
3. Running `source("dev/generate_stubs.R")` in dry-run mode produces no syntax errors
4. diff_schemas.R and generate_stubs.R both source select_schema_files from 01_schema_resolution.R
</verification>

<success_criteria>
- build_function_stub() generates syntactically valid R for chemi endpoints with default options
- Generated roxygen @param tags exactly match function formals
- select_schema_files() lives in 01_schema_resolution.R, shared by diff and stub systems
- detect_parameter_drift() returns a structured tibble of drifts
- CI workflow includes drift reporting in PR body
- All unit tests for stub generator and drift detection pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-build-fixes-test-generator-core/23-02-SUMMARY.md`
</output>
