---
phase: 23-build-fixes-test-generator-core
plan: 05
type: execute
wave: 1
depends_on:
  - "23-04"
files_modified:
  - tests/testthat/test-ct_bioactivity.R
  - tests/testthat/test-ct_descriptors.R
  - tests/testthat/test-ct_details.R
  - tests/testthat/test-ct_functional_use.R
  - tests/testthat/test-ct_lists_all.R
  - tests/testthat/test-chemi_cluster.R
autonomous: true
gap_closure: true
requirements:
  - TGEN-01
must_haves:
  truths:
    - "All generated test files call functions with correct parameter names (no backtick-quoted function definition fragments)"
    - "Generated tests for ct_lists_all use return_dtxsid and coerce parameters, not malformed interpolation"
    - "All 6 affected test files parse as valid R and would execute correct function calls at runtime"
  artifacts:
    - path: "tests/testthat/test-ct_lists_all.R"
      provides: "Correctly parameterized test for ct_lists_all"
      contains: "ct_lists_all(return_dtxsid ="
    - path: "tests/testthat/test-ct_bioactivity.R"
      provides: "Correctly parameterized test for ct_bioactivity"
      contains: "ct_bioactivity(query ="
    - path: "tests/testthat/test-chemi_cluster.R"
      provides: "Correctly parameterized test for chemi_cluster"
    - path: "tests/testthat/test-ct_descriptors.R"
      provides: "Correctly parameterized test for ct_descriptors"
    - path: "tests/testthat/test-ct_details.R"
      provides: "Correctly parameterized test for ct_details"
    - path: "tests/testthat/test-ct_functional_use.R"
      provides: "Correctly parameterized test for ct_functional_use"
  key_links:
    - from: "dev/generate_tests.R"
      to: "tests/testthat/test-*.R"
      via: "generate_test_file() with correct parameter interpolation"
      pattern: "generate_test_file"
---

<objective>
Fix the 6 generated test files that have malformed parameter names due to an interpolation bug in an older version of the test generator.

Purpose: The test generator was fixed in plan 23-03, but 6 test files were generated by the old buggy code and never regenerated. These files pass backtick-quoted function definition fragments as parameter names (e.g., `` `ct_lists_all <- function(` = "DTXSID7020182" ``) instead of actual parameter names (e.g., `return_dtxsid = FALSE`). This makes them fail at runtime.

Output: 6 regenerated test files with correct parameter names and valid function calls.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/23-build-fixes-test-generator-core/23-VERIFICATION.md

<interfaces>
<!-- The current generate_test_file() in dev/generate_tests.R works correctly. -->
<!-- It was fixed in plan 23-03 but these 6 files were never regenerated. -->

From dev/generate_tests.R:
```r
generate_test_file(function_name, function_file, output_dir = "tests/testthat")
# Correctly extracts formals, maps parameter names to test values, generates valid calls

generate_all_tests(r_dir = "R", test_dir = "tests/testthat", force = FALSE)
# Scans R/ for ct_*, chemi_*, cc_* files, generates tests for gaps (or all if force=TRUE)
```

Affected files (contain backtick-quoted `fn_name <- function(` as parameter name):
- tests/testthat/test-ct_bioactivity.R
- tests/testthat/test-ct_descriptors.R
- tests/testthat/test-ct_details.R
- tests/testthat/test-ct_functional_use.R
- tests/testthat/test-ct_lists_all.R
- tests/testthat/test-chemi_cluster.R
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Regenerate the 6 malformed test files using the fixed generator</name>
  <files>
    tests/testthat/test-ct_bioactivity.R
    tests/testthat/test-ct_descriptors.R
    tests/testthat/test-ct_details.R
    tests/testthat/test-ct_functional_use.R
    tests/testthat/test-ct_lists_all.R
    tests/testthat/test-chemi_cluster.R
  </files>
  <action>
    Use the current (fixed) `generate_test_file()` from `dev/generate_tests.R` to regenerate each of the 6 affected test files. Run this R script:

    ```r
    source("dev/generate_tests.R")

    # The 6 files with malformed parameter interpolation
    targets <- c(
      "ct_bioactivity",
      "ct_descriptors",
      "ct_details",
      "ct_functional_use",
      "ct_lists_all",
      "chemi_cluster"
    )

    for (fn in targets) {
      r_file <- file.path("R", paste0(fn, ".R"))
      if (file.exists(r_file)) {
        generate_test_file(fn, r_file, "tests/testthat")
      } else {
        cli::cli_alert_warning("Source file not found: {r_file}")
      }
    }
    ```

    After regeneration, verify each file no longer contains backtick-quoted function definition fragments. Specifically grep for the pattern `` `.*<- function(` `` in all 6 files â€” there should be zero matches.

    **Important:** The current `generate_test_file()` produces a slightly different format than the old generator (no `# Return type:` comment, no `{` braces around assertions). This is expected and correct. The old format came from a buggy code path that no longer exists.
  </action>
  <verify>
    <automated>
      grep -rl "<- function(" tests/testthat/test-ct_bioactivity.R tests/testthat/test-ct_descriptors.R tests/testthat/test-ct_details.R tests/testthat/test-ct_functional_use.R tests/testthat/test-ct_lists_all.R tests/testthat/test-chemi_cluster.R 2>/dev/null | wc -l
      # Must output 0 (no malformed files remaining)
    </automated>
  </verify>
  <done>All 6 test files regenerated with correct parameter names. No backtick-quoted function definition fragments remain. Each file calls its function with actual parameter names (e.g., ct_lists_all(return_dtxsid = FALSE), ct_bioactivity(query = "DTXSID7020182")).</done>
</task>

<task type="auto">
  <name>Task 2: Validate all regenerated tests parse as valid R and have correct parameter names</name>
  <files>
    tests/testthat/test-ct_bioactivity.R
    tests/testthat/test-ct_descriptors.R
    tests/testthat/test-ct_details.R
    tests/testthat/test-ct_functional_use.R
    tests/testthat/test-ct_lists_all.R
    tests/testthat/test-chemi_cluster.R
  </files>
  <action>
    For each of the 6 regenerated test files:

    1. Parse the file with `parse(file = ...)` to verify it's syntactically valid R.
    2. Read the file content and verify it contains correct parameter names by checking:
       - `ct_lists_all.R`: Must contain `return_dtxsid =` (not backtick-quoted fragment)
       - `ct_bioactivity.R`: Must contain a real parameter name like `query =` or `dtxsid =`
       - Each file must NOT contain the pattern `` `.*<- function(` ``
    3. Verify each test file contains the expected test variants: `_single`, `_batch` (unless static endpoint), and either `_error` or error handling test.
    4. Run a broader check: scan ALL 313 generated test files for any remaining backtick-quoted function definition fragments, to ensure no other files slipped through.

    Run validation script:
    ```r
    # Parse check for 6 regenerated files
    targets <- c("ct_bioactivity", "ct_descriptors", "ct_details",
                  "ct_functional_use", "ct_lists_all", "chemi_cluster")
    for (fn in targets) {
      f <- file.path("tests/testthat", paste0("test-", fn, ".R"))
      tryCatch({
        parse(file = f)
        cat("PASS:", f, "\n")
      }, error = function(e) {
        cat("FAIL:", f, "-", e$message, "\n")
      })
    }

    # Broader check: any remaining malformed files?
    all_tests <- list.files("tests/testthat", pattern = "^test-(ct_|chemi_|cc_)", full.names = TRUE)
    malformed <- character(0)
    for (f in all_tests) {
      content <- readLines(f, warn = FALSE)
      if (any(grepl("<- function\\(", content))) {
        malformed <- c(malformed, basename(f))
      }
    }
    cat("\nMalformed files remaining:", length(malformed), "\n")
    if (length(malformed) > 0) cat(malformed, sep = "\n")
    ```

    If any malformed files are found beyond the original 6, regenerate those as well using the same approach from Task 1.
  </action>
  <verify>
    <automated>
      grep -rl "<- function(" tests/testthat/test-ct_*.R tests/testthat/test-chemi_*.R tests/testthat/test-cc_*.R 2>/dev/null | wc -l
      # Must output 0
    </automated>
  </verify>
  <done>All 6 regenerated files parse as valid R. No generated test files in the entire test suite contain malformed backtick-quoted parameter names. The broader scan of all 313 generated test files confirms zero remaining instances of the interpolation bug.</done>
</task>

</tasks>

<verification>
1. Zero test files contain the pattern `` `.*<- function(` `` as a parameter name in function calls
2. All 6 regenerated files parse without error via `parse(file = ...)`
3. ct_lists_all test calls `ct_lists_all(return_dtxsid = ...)` with correct parameter name
4. ct_bioactivity test calls with a real parameter name, not a function definition fragment
5. No regressions in the other 307 generated test files
</verification>

<success_criteria>
- TGEN-01 fully satisfied: all generated test files call functions with correctly typed parameters
- Zero malformed parameter interpolation in any test file
- All generated test files are syntactically valid R
</success_criteria>

<output>
After completion, create `.planning/phases/23-build-fixes-test-generator-core/23-05-SUMMARY.md`
</output>
