---
phase: 17-schema-diffing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dev/diff_schemas.R
autonomous: true

must_haves:
  truths:
    - "Script can detect which endpoints were added between two schema versions"
    - "Script can detect which endpoints were removed between two schema versions"
    - "Script can detect which endpoints were modified (changed params, body, method)"
    - "Script classifies removed endpoints and changed params as breaking changes"
    - "Script classifies added endpoints as non-breaking changes"
    - "Script outputs structured markdown summary suitable for PR body injection"
  artifacts:
    - path: "dev/diff_schemas.R"
      provides: "Schema endpoint-level diff engine"
      min_lines: 100
      contains: "diff_schemas"
  key_links:
    - from: "dev/diff_schemas.R"
      to: "dev/endpoint_eval/04_openapi_parser.R"
      via: "source() to load openapi_to_spec()"
      pattern: "source.*04_openapi_parser"
    - from: "dev/diff_schemas.R"
      to: "schema/*.json"
      via: "jsonlite::fromJSON to parse schema files"
      pattern: "fromJSON"
---

<objective>
Create an R script that compares two versions of OpenAPI schema files at the endpoint level and produces a structured diff report with breaking/non-breaking classification.

Purpose: DIFF-01 and DIFF-02 require endpoint-level change detection with breaking change classification. This script is the diff engine that the CI workflow (Plan 02) will invoke.

Output: `dev/diff_schemas.R` with functions `diff_schemas()`, `diff_single_schema()`, and `format_diff_markdown()`.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@dev/endpoint_eval/04_openapi_parser.R
@.github/workflows/schema-check.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dev/diff_schemas.R with endpoint-level diffing</name>
  <files>dev/diff_schemas.R</files>
  <action>
Create `dev/diff_schemas.R` with the following functions:

**1. `diff_single_schema(old_path, new_path)`**
- Source `dev/endpoint_eval/04_openapi_parser.R` (if not already loaded) to get `openapi_to_spec()`
- Parse both schema files with `jsonlite::fromJSON(simplifyVector = FALSE)` then `openapi_to_spec()`
- Create endpoint keys as `"{METHOD} {route}"` (e.g., "GET /chemical/detail/{dtxsid}")
- Compare old vs new endpoint sets:
  - **Added:** keys in new but not old -> classify as `non-breaking`
  - **Removed:** keys in old but not new -> classify as `breaking`
  - **Modified:** keys in both, but with differences -> check what changed:
    - Changed params (added/removed/renamed) -> `breaking` if params removed, `non-breaking` if params added
    - Changed has_body (gained or lost request body) -> `breaking`
    - Changed deprecated status -> `non-breaking`
- Return a list with: `schema_file` (basename), `added` (tibble of new endpoints with route, method, summary), `removed` (tibble), `modified` (tibble with route, method, change_type, detail, breaking)
- Handle edge case: if either file doesn't exist or fails to parse, return a list with `error` field

For the "modified" detection, compare these columns from openapi_to_spec output:
- `params` (comma-separated param string)
- `has_body` (logical)
- `body_params` (comma-separated body param string)
- `deprecated` (logical)

For each modified endpoint, produce a human-readable `detail` string like:
- "params changed: old=[a,b] new=[a,b,c]"
- "body params changed: old=[x] new=[x,y]"
- "request body added" / "request body removed"
- "endpoint deprecated"

**2. `diff_schemas(old_dir, new_dir, pattern = "\\.json$")`**
- List all JSON files in both directories
- For each file present in either directory:
  - If only in new_dir -> entire file is new (all endpoints are "added")
  - If only in old_dir -> entire file is removed (all endpoints are "removed")
  - If in both -> call `diff_single_schema(old_path, new_path)`
- Filter out schemas with zero changes
- Return a list of per-schema diff results

**3. `format_diff_markdown(diff_results)`**
- Takes output of `diff_schemas()` and produces a markdown string for PR body injection
- Format:

```
### Endpoint Changes

**Summary:** X endpoints added, Y removed, Z modified across N schemas

#### Breaking Changes
| Schema | Endpoint | Change | Detail |
|--------|----------|--------|--------|
| ctx-hazard-prod | DELETE /hazard/{id} | Removed | Endpoint no longer exists |
| chemi-safety-prod | POST /safety/calc | Modified | body params changed: old=[sid] new=[] |

#### Non-Breaking Changes
| Schema | Endpoint | Change | Detail |
|--------|----------|--------|--------|
| ctx-chemical-prod | GET /chemical/search/by-formula/{formula} | Added | New endpoint |
| chemi-alerts-prod | GET /alerts/status | Modified | endpoint deprecated |
```

- If no changes at all, return "No endpoint-level changes detected."
- If no breaking changes, omit the breaking section
- If no non-breaking changes, omit that section

**4. `classify_param_change(old_params, new_params)`** (helper)
- old_params and new_params are comma-separated strings
- Returns list(breaking = logical, detail = string)
- Breaking if any param was removed; non-breaking if only additions

**5. Main block (when sourced from CI):**
At the bottom of the file, add a block guarded by `if (sys.nframe() == 0)` that:
- Accepts command-line args: `old_dir` and `new_dir` (defaults to "schema_old" and "schema")
- Runs `diff_schemas(old_dir, new_dir)`
- Calls `format_diff_markdown()` and writes result to `schema_diff_report.md`
- Also writes key counts to stdout for GitHub Actions output capture:
  - `::set-output name=breaking_count::N`
  - `::set-output name=nonbreaking_count::N`
  - `::set-output name=diff_report::$(cat schema_diff_report.md)`

Important: Use `here::here()` for path resolution. Source the openapi parser with `source(here::here("dev/endpoint_eval/04_openapi_parser.R"))`. Suppress chatty cli output from openapi_to_spec with `suppressMessages()`.

Do NOT use GitHub's deprecated `::set-output` syntax. Instead, write to `$GITHUB_OUTPUT` environment file. Since this script runs standalone, just write the counts to stdout with a simple format like `BREAKING_COUNT=N` and `NONBREAKING_COUNT=N` that the workflow step can parse. Write the markdown report to a file (`schema_diff_report.md`) that the workflow reads.
  </action>
  <verify>
Run from project root:
```
"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('dev/diff_schemas.R'); cat('Functions loaded:', exists('diff_schemas'), exists('diff_single_schema'), exists('format_diff_markdown'), '\n')"
```
All three functions should exist (TRUE TRUE TRUE).

Also verify with a self-test: parse one existing schema against itself (expect zero changes):
```
"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "source('dev/diff_schemas.R'); res <- diff_single_schema('schema/ctx-hazard-prod.json', 'schema/ctx-hazard-prod.json'); cat('Added:', nrow(res$added), 'Removed:', nrow(res$removed), 'Modified:', nrow(res$modified), '\n')"
```
Expected output: Added: 0 Removed: 0 Modified: 0
  </verify>
  <done>
- dev/diff_schemas.R exists with diff_schemas(), diff_single_schema(), format_diff_markdown() functions
- Diffing identical schema returns zero changes
- Functions correctly source openapi_to_spec from dev/endpoint_eval/04_openapi_parser.R
  </done>
</task>

<task type="auto">
  <name>Task 2: Test diff engine with synthetic schema changes</name>
  <files>dev/diff_schemas.R</files>
  <action>
After Task 1 is verified, run an integration test to confirm the diff engine handles all three change types correctly:

1. Copy `schema/ctx-hazard-prod.json` to a temp directory as the "old" version
2. Parse the JSON, make three synthetic modifications to create a "new" version:
   - Remove one endpoint (delete a path from the paths object)
   - Add a synthetic endpoint (add a new path like "/hazard/test-new" with GET method)
   - Modify an existing endpoint (add a new query parameter to an existing endpoint)
3. Write modified JSON to another temp directory as "new" version
4. Run `diff_single_schema(old_path, new_path)` and verify:
   - `added` has at least 1 row
   - `removed` has at least 1 row
   - `modified` has at least 1 row
   - The removed endpoint is classified as breaking
   - The added endpoint is classified as non-breaking
5. Run `format_diff_markdown()` on the results wrapped in a list, verify it produces markdown containing "Breaking Changes" and "Non-Breaking Changes" sections
6. Clean up temp directories

This is a validation step, not a permanent test file. Run it inline and report results. If any assertion fails, fix the diff engine code.
  </action>
  <verify>
The inline test produces output confirming:
- Added count >= 1
- Removed count >= 1
- Modified count >= 1
- Markdown output contains "Breaking Changes" header
- Markdown output contains "Non-Breaking Changes" header
  </verify>
  <done>
- diff_single_schema correctly detects added, removed, and modified endpoints
- Breaking/non-breaking classification is correct
- format_diff_markdown produces structured markdown tables
  </done>
</task>

</tasks>

<verification>
1. `dev/diff_schemas.R` exists and sources cleanly without errors
2. Diffing identical schemas produces zero changes
3. Diffing synthetically modified schemas correctly classifies added (non-breaking), removed (breaking), and modified endpoints
4. `format_diff_markdown()` produces valid markdown with proper table structure
</verification>

<success_criteria>
- DIFF-01 partially satisfied: script can detect added/removed/modified endpoints
- DIFF-02 partially satisfied: script classifies breaking vs non-breaking changes
- Full satisfaction requires Plan 02 (CI workflow integration)
</success_criteria>

<output>
After completion, create `.planning/phases/17-schema-diffing/17-01-SUMMARY.md`
</output>
