---
phase: 17-schema-diffing
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - .github/workflows/schema-check.yml
autonomous: true

must_haves:
  truths:
    - "Workflow saves old schemas before downloading new ones so diff has a baseline"
    - "Workflow runs diff_schemas.R to produce endpoint-level diff report"
    - "PR body includes structured endpoint-level diff summary with breaking/non-breaking tables"
    - "PR body still includes existing coverage and stub generation info"
  artifacts:
    - path: ".github/workflows/schema-check.yml"
      provides: "Updated CI workflow with schema diffing integration"
      contains: "diff_schemas"
  key_links:
    - from: ".github/workflows/schema-check.yml"
      to: "dev/diff_schemas.R"
      via: "source() in Rscript step"
      pattern: "diff_schemas"
    - from: ".github/workflows/schema-check.yml"
      to: "schema_diff_report.md"
      via: "reads generated report file for PR body"
      pattern: "schema_diff_report"
---

<objective>
Integrate the schema diff engine into the GitHub Actions workflow so that auto-generated PRs include endpoint-level change summaries with breaking/non-breaking classification.

Purpose: Completes DIFF-01, DIFF-02, and DIFF-03 by wiring the diff script into the CI workflow and injecting its output into the PR body.

Output: Updated `.github/workflows/schema-check.yml` with schema diffing steps and enriched PR body template.
</objective>

<execution_context>
@C:/Users/sxthi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sxthi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-schema-diffing/17-01-SUMMARY.md
@.github/workflows/schema-check.yml
@dev/diff_schemas.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add schema preservation and diff steps to workflow</name>
  <files>.github/workflows/schema-check.yml</files>
  <action>
Modify `.github/workflows/schema-check.yml` to add schema diffing. Insert new steps in the correct order:

**Step 1: "Save old schemas" (insert AFTER "Ensure internal data" but BEFORE "Download schemas")**
```yaml
- name: Save old schemas for diff
  run: |
    if [ -d "schema" ] && [ "$(ls -A schema/*.json 2>/dev/null)" ]; then
      cp -r schema schema_old
      echo "Saved $(ls schema_old/*.json | wc -l) schema files for diffing"
    else
      mkdir -p schema_old
      echo "No existing schemas to save (fresh run)"
    fi
```

This preserves the current committed schemas as baseline before `ct_schema()` / `chemi_schema()` / `cc_schema()` download fresh ones.

**Step 2: "Diff schemas" (insert AFTER "Compute schema hashes" but BEFORE "Check for schema changes")**
```yaml
- name: Diff schemas
  id: diff
  run: |
    source("dev/endpoint_eval/04_openapi_parser.R")
    source("dev/diff_schemas.R")
    results <- diff_schemas("schema_old", "schema")
    md <- format_diff_markdown(results)
    writeLines(md, "schema_diff_report.md")

    # Count changes for workflow outputs
    breaking <- sum(sapply(results, function(r) {
      nrow(r$removed) + sum(r$modified$breaking)
    }))
    nonbreaking <- sum(sapply(results, function(r) {
      nrow(r$added) + sum(!r$modified$breaking)
    }))

    # Write to GITHUB_OUTPUT
    gh_output <- Sys.getenv("GITHUB_OUTPUT")
    cat(sprintf("breaking_count=%d\n", breaking), file = gh_output, append = TRUE)
    cat(sprintf("nonbreaking_count=%d\n", nonbreaking), file = gh_output, append = TRUE)
    cat(sprintf("has_endpoint_changes=%s\n", tolower(as.character(breaking + nonbreaking > 0))), file = gh_output, append = TRUE)

    cli::cli_alert_info("Schema diff: {breaking} breaking, {nonbreaking} non-breaking changes")
  shell: Rscript {0}
```

**Step 3: Update the "Create Pull Request" step's `body` field**

Replace the current static PR body with a dynamic one that includes the diff report. Use bash to read the report file and inject it. Change the PR creation step to:

```yaml
- name: Prepare PR body
  id: pr_body
  if: steps.changes.outputs.has_changes == 'true'
  run: |
    # Build PR body from template + diff report
    cat > pr_body.md << 'HEADER'
    ## Automated Schema Update

    This PR was automatically generated by the schema check workflow.
    HEADER

    # Add endpoint diff section if report exists
    if [ -f "schema_diff_report.md" ]; then
      echo "" >> pr_body.md
      cat schema_diff_report.md >> pr_body.md
    fi

    # Add stub generation section
    cat >> pr_body.md << 'STUBS'

    ### Function Stub Generation
    STUBS
    echo "- **Stubs Generated:** ${{ steps.stubs.outputs.stubs_generated || '0' }}" >> pr_body.md
    echo "- **New Files Created:** ${{ steps.stubs.outputs.stubs_created || '0' }}" >> pr_body.md
    echo "- **Existing Files Updated:** ${{ steps.stubs.outputs.stubs_appended || '0' }}" >> pr_body.md

    # Add coverage section
    cat >> pr_body.md << 'COVERAGE'

    ### API Coverage
    | API | Coverage | Endpoints | Functions |
    |-----|----------|-----------|-----------|
    COVERAGE
    echo "| CompTox Dashboard (ct_*) | ${{ steps.coverage.outputs.ccd_coverage || 'N/A' }}% | ${{ steps.coverage.outputs.ccd_endpoints || 'N/A' }} | ${{ steps.coverage.outputs.ccd_functions || 'N/A' }} |" >> pr_body.md
    echo "| Cheminformatics (chemi_*) | ${{ steps.coverage.outputs.chemi_coverage || 'N/A' }}% | ${{ steps.coverage.outputs.chemi_endpoints || 'N/A' }} | ${{ steps.coverage.outputs.chemi_functions || 'N/A' }} |" >> pr_body.md

    # Add review checklist with breaking change awareness
    BREAKING="${{ steps.diff.outputs.breaking_count || '0' }}"
    cat >> pr_body.md << 'CHECKLIST'

    ### Review Checklist
    CHECKLIST
    if [ "$BREAKING" != "0" ]; then
      echo "- [ ] **⚠ BREAKING CHANGES detected** — review removed/modified endpoints above" >> pr_body.md
    fi
    cat >> pr_body.md << 'TAIL'
    - [ ] Review schema changes for breaking API modifications
    - [ ] Review generated function stubs for correctness
    - [ ] Check if any existing package functions need updates
    - [ ] Run tests to verify compatibility

    ---
    Generated by GitHub Actions
    TAIL

- name: Create Pull Request
  if: steps.changes.outputs.has_changes == 'true'
  uses: peter-evans/create-pull-request@v6
  with:
    token: ${{ secrets.GITHUB_TOKEN }}
    commit-message: "chore: update API schemas and generate function stubs"
    title: "chore: API schema updates detected"
    body-path: pr_body.md
    branch: automated/schema-update
    delete-branch: true
    labels: |
      automated
      schemas
```

Key changes to the existing workflow:
- Replace inline `body:` with `body-path: pr_body.md` in the create-pull-request step
- Add the "Prepare PR body" step that constructs the body from template + diff report
- Add breaking change warning to review checklist when breaking changes are detected
- Add `automated` label conditionally if there are breaking changes (could add `breaking-change` label)

Also add `stringr` and `purrr` to the extra-packages list since openapi_to_spec needs them:
```yaml
extra-packages: |
  any::pkgload
  any::cli
  any::here
  any::jsonlite
  any::tidyverse
  any::devtools
  any::fs
  any::readr
  any::forcats
  any::usethis
  any::stringr
  any::purrr
```
(Note: tidyverse already includes stringr and purrr, but explicit listing ensures they're available even if tidyverse install is partial.)

Do NOT change any other workflow steps (Ensure internal data, Download schemas, Generate function stubs, Update documentation, Calculate coverage). Only add/modify the steps described above.
  </action>
  <verify>
Validate the YAML syntax:
```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/schema-check.yml'))" 2>&1 || echo "YAML syntax error"
```
If python3 not available, use:
```bash
"C:\Program Files\R\R-4.5.1\bin\Rscript.exe" -e "cat(yaml::yaml.load_file('.github/workflows/schema-check.yml') |> length(), 'top-level keys parsed\n')"
```

Verify the workflow file contains all expected elements:
- "Save old schemas for diff" step
- "Diff schemas" step with `source("dev/diff_schemas.R")`
- "Prepare PR body" step
- `body-path: pr_body.md` in create-pull-request
- `schema_diff_report.md` reference
  </verify>
  <done>
- Workflow preserves old schemas before downloading new ones
- Workflow runs diff_schemas.R to generate endpoint-level diff report
- PR body includes structured diff summary from schema_diff_report.md
- PR body retains existing stub generation and coverage info
- Breaking change count is surfaced in PR body review checklist
- YAML syntax is valid
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/schema-check.yml` has valid YAML syntax
2. Workflow step order is correct: ensure data -> save old schemas -> download schemas -> compute hashes -> diff schemas -> check changes -> generate stubs -> update docs -> coverage -> prepare PR body -> create PR
3. The "Diff schemas" step sources both the parser and diff_schemas.R
4. PR body template includes the diff report file content
5. Breaking change count appears in workflow outputs
</verification>

<success_criteria>
- DIFF-01: Workflow reports which specific endpoints changed (via diff report in PR body)
- DIFF-02: Changes classified as breaking or non-breaking in the diff report
- DIFF-03: Auto-generated PR body includes structured endpoint-level diff summary
</success_criteria>

<output>
After completion, create `.planning/phases/17-schema-diffing/17-02-SUMMARY.md`
</output>
