---
phase: 17-schema-diffing
plan: 02
subsystem: ci-integration
tags: [schema-diff, github-actions, pr-automation]
dependency_graph:
  requires: [diff_schemas.R from 17-01, openapi_to_spec from 04_openapi_parser.R]
  provides: [Automated schema diffing in CI, Enhanced PR bodies with endpoint changes]
  affects: [GitHub Actions workflow, automated PRs]
tech_stack:
  added: [Schema diffing integration in CI]
  patterns: [Multi-step bash heredocs, Dynamic PR body construction, Breaking change detection in workflow]
key_files:
  created: []
  modified:
    - .github/workflows/schema-check.yml
decisions:
  - Use body-path instead of inline body for PR creation to support dynamic diff report injection
  - Run diff step after hash computation but before change detection to ensure report is available
  - Add breaking change warning conditionally based on diff output counts
metrics:
  duration: 1min
  completed: 2026-02-12
---

# Phase 17 Plan 02: CI Workflow Integration Summary

**One-liner:** GitHub Actions workflow now generates endpoint-level diff reports with breaking/non-breaking classification for automated schema update PRs

## What Was Built

Integrated the schema diff engine from Plan 01 into `.github/workflows/schema-check.yml` with five key modifications:

### 1. Schema Preservation Step
Added "Save old schemas for diff" step (inserted after "Ensure internal data", before "Download schemas"):
- Copies existing `schema/` directory to `schema_old/` before downloading fresh schemas
- Creates empty `schema_old/` directory if no existing schemas (fresh run scenario)
- Provides baseline for diff comparison

### 2. Schema Diff Step
Added "Diff schemas" step (inserted after "Compute schema hashes", before "Check for schema changes"):
- Sources `dev/endpoint_eval/04_openapi_parser.R` and `dev/diff_schemas.R`
- Runs `diff_schemas("schema_old", "schema")`
- Generates `schema_diff_report.md` via `format_diff_markdown()`
- Calculates and outputs to `GITHUB_OUTPUT`:
  - `breaking_count`: Count of breaking changes (removed endpoints + breaking modifications)
  - `nonbreaking_count`: Count of non-breaking changes (added endpoints + non-breaking modifications)
  - `has_endpoint_changes`: Boolean indicating if any endpoint-level changes detected

### 3. Dynamic PR Body Construction
Added "Prepare PR body" step (inserted before "Create Pull Request"):
- Constructs PR body using bash heredocs with multiple sections:
  - Header: Standard automated PR message
  - Endpoint Changes: Injects `schema_diff_report.md` if it exists
  - Function Stub Generation: Stats from stub generation step
  - API Coverage: Coverage metrics table
  - Review Checklist: Standard checklist PLUS conditional breaking change warning
- Breaking change warning added when `breaking_count > 0`
- Writes final body to `pr_body.md` file

### 4. Updated PR Creation Step
Modified "Create Pull Request" step:
- Changed from inline `body:` to `body-path: pr_body.md`
- Allows dynamic content injection from the prepared file
- Retains all other configuration (branch name, labels, etc.)

### 5. Added Missing Dependencies
Updated `extra-packages` list:
- Added `any::stringr` (explicitly, though included in tidyverse)
- Added `any::purrr` (explicitly, though included in tidyverse)
- Ensures `openapi_to_spec()` dependencies are available even if tidyverse install is partial

## Workflow Step Order

The final workflow executes in this sequence:
1. Ensure internal data (`R/sysdata.rda` check/regeneration)
2. **Save old schemas** (preservation for diffing)
3. Download schemas (refresh from APIs)
4. Compute schema hashes (MD5 checksums)
5. **Diff schemas** (endpoint-level comparison)
6. Check for schema changes (git diff detection)
7. Generate function stubs (conditional on changes)
8. Update documentation (conditional on changes)
9. Calculate coverage (conditional on changes)
10. Check for all changes (git status check)
11. **Prepare PR body** (construct dynamic body with diff report)
12. **Create Pull Request** (use prepared body file)

## PR Body Structure

The generated PR body now includes:

```markdown
## Automated Schema Update

This PR was automatically generated by the schema check workflow.

### Endpoint Changes
**Summary:** X endpoints added, Y removed, Z modified across N schemas

#### Breaking Changes
| Schema | Endpoint | Change | Detail |
|--------|----------|--------|--------|
| ... | ... | ... | ... |

#### Non-Breaking Changes
| Schema | Endpoint | Change | Detail |
|--------|----------|--------|--------|
| ... | ... | ... | ... |

### Function Stub Generation
- **Stubs Generated:** X
- **New Files Created:** Y
- **Existing Files Updated:** Z

### API Coverage
| API | Coverage | Endpoints | Functions |
|-----|----------|-----------|-----------|
| CompTox Dashboard (ct_*) | X% | Y | Z |
| Cheminformatics (chemi_*) | A% | B | C |

### Review Checklist
- [ ] **⚠ BREAKING CHANGES detected** — review removed/modified endpoints above (conditional)
- [ ] Review schema changes for breaking API modifications
- [ ] Review generated function stubs for correctness
- [ ] Check if any existing package functions need updates
- [ ] Run tests to verify compatibility

---
Generated by GitHub Actions
```

## Success Criteria Met

- ✓ **DIFF-01**: Workflow reports which specific endpoints changed via diff report in PR body
- ✓ **DIFF-02**: Changes classified as breaking or non-breaking in the diff report tables
- ✓ **DIFF-03**: Auto-generated PR body includes structured endpoint-level diff summary

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

1. ✓ YAML syntax valid: 3 top-level keys parsed successfully
2. ✓ All expected elements present:
   - "Save old schemas for diff" step: FOUND
   - "Diff schemas" step: FOUND
   - `source("dev/diff_schemas.R")`: FOUND
   - "Prepare PR body" step: FOUND
   - `body-path: pr_body.md`: FOUND
   - `schema_diff_report.md` references: FOUND (3 occurrences)
3. ✓ Step order correct: preservation → download → hash → diff → check → stubs → docs → coverage → prepare → create PR
4. ✓ Breaking change count surfaced in workflow outputs and PR body
5. ✓ PR body retains existing stub generation and coverage info

## Integration Points

**Inputs:**
- `schema_old/` directory (created by "Save old schemas" step)
- `schema/` directory (freshly downloaded schemas)
- `dev/diff_schemas.R` (diff engine from Plan 01)
- `dev/endpoint_eval/04_openapi_parser.R` (OpenAPI parser)

**Outputs:**
- `schema_diff_report.md` (endpoint-level diff in markdown format)
- `pr_body.md` (complete PR body for peter-evans/create-pull-request)
- Workflow outputs: `breaking_count`, `nonbreaking_count`, `has_endpoint_changes`

**Consumers:**
- GitHub Actions workflow (reads diff report, constructs PR body)
- Pull request reviewers (view endpoint changes in PR body)
- Package maintainers (assess breaking changes before merge)

## Next Steps

Plan 17-02 completes Phase 17 (Schema Diffing). The system now:
- Automatically detects endpoint-level changes when schemas update
- Classifies changes as breaking or non-breaking
- Surfaces this information in auto-generated PR bodies
- Provides reviewers with structured summaries for informed decision-making

Phase 17 is now complete. Ready to proceed to Phase 18 (next phase in roadmap) or address any follow-up work.

## Self-Check: PASSED

**Files modified:**
```
[FOUND] .github/workflows/schema-check.yml
```

**Commits created:**
```
[FOUND] dfd029a - feat(17-02): integrate schema diffing into CI workflow
```

**Workflow elements verified:**
- Save old schemas step: PRESENT
- Diff schemas step: PRESENT
- Prepare PR body step: PRESENT
- body-path usage: PRESENT
- Breaking change warning: PRESENT
- stringr/purrr dependencies: PRESENT

**YAML validation:**
- Syntax check: PASSED (3 top-level keys)
- Step order: CORRECT
- All referenced files exist: CONFIRMED

---

*Completed: 2026-02-12 | Duration: 1 minute*
