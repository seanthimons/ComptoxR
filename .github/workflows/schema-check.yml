---
name: Schema Update Check
on:
  schedule:
    - cron: 0 9 * * 1,3,5
  workflow_dispatch: null
jobs:
  check-schemas:
    runs-on: ubuntu-latest
    name: Check for Schema Updates
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: integration
          fetch-depth: 0
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: release
          use-public-rspm: true
      - name: Install dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::pkgload, any::cli, any::here
          needs: check
      - name: Download schemas
        run: |
          pkgload::load_all()
          cli::cli_h1("Downloading CTX schemas")
          ct_schema()
          cli::cli_h1("Downloading Cheminformatics schemas")
          chemi_schema()
          cli::cli_alert_success("Schema download complete")
        shell: Rscript {0}
      - name: Compute schema hashes
        id: hash
        run: >
          schema_files <- list.files("schema", pattern = "\\.json$", full.names =
          TRUE)

          if (length(schema_files) == 0) {
            cli::cli_abort("No schema files found!")
          }

          hashes <- data.frame(
            file = basename(schema_files),
            hash = sapply(schema_files, function(f) tools::md5sum(f), USE.NAMES = FALSE)
          )

          # Sort for consistent ordering

          hashes <- hashes[order(hashes$file), ]

          # Write updated hashes

          write.csv(hashes, "schema_hashes.csv", row.names = FALSE, quote = FALSE)

          cli::cli_alert_info("Computed hashes for {nrow(hashes)} schema files")
        shell: Rscript {0}
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet schema/ schema_hashes.csv; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No schema changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Schema changes detected!"
            git diff --stat schema/ schema_hashes.csv
          fi
      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update API schemas"
          title: "chore: API schema updates detected"
          body: |
            ## Automated Schema Update
            This PR was automatically generated by the schema check workflow.
            The following API schemas have been updated:
            ```
            ${{ steps.changes.outputs.diff || 'See changed files below' }}
            ```
            ### Review Checklist
            - [ ] Review schema changes for breaking API modifications
            - [ ] Check if any package functions need updates
            - [ ] Run tests to verify compatibility
            ---
            ðŸ¤– Generated by GitHub Actions
          branch: automated/schema-update
          delete-branch: true
          labels: |
            automated
            schemas
