# Periodic schema update check
# Runs on schedule to detect API schema changes
name: Schema Update Check

on:
  schedule:
    # Run Monday, Wednesday, Friday at 9am UTC
    - cron: '0 9 * * 1,3,5'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  check-schemas:
    runs-on: ubuntu-latest
    name: Check for Schema Updates
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: integration
          fetch-depth: 0

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: release
          use-public-rspm: true

      - name: Install dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::pkgload, any::cli, any::here, any::desc
          needs: check

      - name: Bump nightly version
        id: version
        run: |
          current <- desc::desc_get_version()
          parts <- as.integer(strsplit(as.character(current), "\\.")[[1]])

          if (length(parts) == 4) {
            parts[4] <- parts[4] + 1
          } else {
            parts <- c(parts, 9001L)
          }

          new_version <- paste(parts, collapse = ".")
          desc::desc_set_version(new_version)
          cli::cli_alert_success("Version bumped: {current} -> {new_version}")
          cat(sprintf("new_version=%s\n", new_version), file = Sys.getenv("GITHUB_OUTPUT"), append = TRUE)
          cat(sprintf("old_version=%s\n", as.character(current)), file = Sys.getenv("GITHUB_OUTPUT"), append = TRUE)
        shell: Rscript {0}

      - name: Download schemas
        run: |
          pkgload::load_all()
          ct_schema()
          chemi_schema()
          cc_schema()
        shell: Rscript {0}

      - name: Compute schema hashes
        id: hash
        run: >
          schema_files <- list.files("schema", pattern = "\\.json$", full.names =
          TRUE)

          if (length(schema_files) == 0) {
            cli::cli_abort("No schema files found!")
          }

          hashes <- data.frame(
            file = basename(schema_files),
            hash = sapply(schema_files, function(f) tools::md5sum(f), USE.NAMES = FALSE)
          )
          hashes <- hashes[order(hashes$file), ]
          write.csv(hashes, "schema_hashes.csv", row.names = FALSE, quote = FALSE)
          cli::cli_alert_info("Computed hashes for {nrow(hashes)} schema files")
        shell: Rscript {0}

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet schema/ schema_hashes.csv DESCRIPTION; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No schema changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Schema changes detected!"
            git diff --stat schema/ schema_hashes.csv DESCRIPTION
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update API schemas and bump nightly version to ${{ steps.version.outputs.new_version }}"
          title: "chore: API schema updates detected (${{ steps.version.outputs.new_version }})"
          body: |
            ## Automated Schema Update
            This PR was automatically generated by the schema check workflow.

            ### Version Bump
            `${{ steps.version.outputs.old_version }}` â†’ `${{ steps.version.outputs.new_version }}`

            The following API schemas have been updated:
            ```
            ${{ steps.changes.outputs.diff || 'See changed files below' }}
            ```
            ### Review Checklist
            - [ ] Review schema changes for breaking API modifications
            - [ ] Check if any package functions need updates
            - [ ] Run tests to verify compatibility
            ---
            ðŸ¤– Generated by GitHub Actions
          branch: automated/schema-update
          delete-branch: true
          labels: |
            automated
            schemas

      - name: Build nightly package
        if: steps.changes.outputs.changed == 'true'
        run: R CMD build --no-build-vignettes --no-manual .

      - name: Publish nightly release
        if: steps.changes.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: nightly-${{ steps.version.outputs.new_version }}
          name: "Nightly ${{ steps.version.outputs.new_version }}"
          body: |
            ## Nightly Build `${{ steps.version.outputs.new_version }}`
            Built automatically from the `integration` branch on ${{ github.run_id }}.
            This is a pre-release build â€” **not intended for production use**.
          files: ComptoxR_${{ steps.version.outputs.new_version }}.tar.gz
          prerelease: true
          make_latest: false
