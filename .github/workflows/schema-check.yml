# Periodic schema update check
# Runs on schedule to detect API schema changes and generate function stubs
name: Schema Update Check

on:
  schedule:
    # Run Monday, Wednesday, Friday at 9am UTC
    - cron: '0 9 * * 1,3,5'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  check-schemas:
    runs-on: ubuntu-latest
    name: Check for Schema Updates
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: integration
          fetch-depth: 0

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: release
          use-public-rspm: true

      - name: Install dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::pkgload
            any::cli
            any::here
            any::jsonlite
            any::tidyverse
            any::devtools
            any::fs
            any::readr
            any::forcats
            any::usethis
          needs: check

      - name: Ensure internal data
        run: |
          if (!file.exists("R/sysdata.rda")) {
            cli::cli_alert_warning("sysdata.rda missing, regenerating from data-raw/")
            source("data-raw/unicode_map.R")
          } else {
            cli::cli_alert_info("sysdata.rda found, skipping regeneration")
          }
        shell: Rscript {0}

      - name: Download schemas
        run: |
          pkgload::load_all()
          ct_schema()
          chemi_schema()
          cc_schema()
        shell: Rscript {0}

      - name: Compute schema hashes
        id: hash
        run: >
          schema_files <- list.files("schema", pattern = "\\.json$", full.names =
          TRUE)

          if (length(schema_files) == 0) {
            cli::cli_abort("No schema files found!")
          }

          hashes <- data.frame(
            file = basename(schema_files),
            hash = sapply(schema_files, function(f) tools::md5sum(f), USE.NAMES = FALSE)
          )
          # Sort for consistent ordering
          hashes <- hashes[order(hashes$file), ]
          # Write updated hashes
          write.csv(hashes, "schema_hashes.csv", row.names = FALSE, quote = FALSE)
          cli::cli_alert_info("Computed hashes for {nrow(hashes)} schema files")
        shell: Rscript {0}

      - name: Check for schema changes
        id: schema_changes
        run: |
          if git diff --quiet schema/ schema_hashes.csv; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No schema changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Schema changes detected!"
            git diff --stat schema/ schema_hashes.csv
          fi

      - name: Generate function stubs
        id: stubs
        if: steps.schema_changes.outputs.changed == 'true'
        run: |
          source("dev/generate_stubs.R")
        shell: Rscript {0}

      - name: Update documentation
        if: steps.schema_changes.outputs.changed == 'true'
        run: |
          devtools::document()
        shell: Rscript {0}

      - name: Calculate coverage
        id: coverage
        if: steps.schema_changes.outputs.changed == 'true'
        run: |
          source("dev/calculate_coverage.R")
        shell: Rscript {0}

      - name: Check for all changes
        id: changes
        run: |
          # Check if there are any changes to commit
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff --stat
            git status --short
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update API schemas and generate function stubs"
          title: "chore: API schema updates detected"
          body: |
            ## Automated Schema Update

            This PR was automatically generated by the schema check workflow.

            ### Schema Changes
            The following API schemas have been updated. See changed files below for details.

            ### Function Stub Generation
            - **Stubs Generated:** ${{ steps.stubs.outputs.stubs_generated || '0' }}
            - **New Files Created:** ${{ steps.stubs.outputs.stubs_created || '0' }}
            - **Existing Files Updated:** ${{ steps.stubs.outputs.stubs_appended || '0' }}

            ### API Coverage
            | API | Coverage | Endpoints | Functions |
            |-----|----------|-----------|-----------|
            | CompTox Dashboard (ct_*) | ${{ steps.coverage.outputs.ccd_coverage || 'N/A' }}% | ${{ steps.coverage.outputs.ccd_endpoints || 'N/A' }} | ${{ steps.coverage.outputs.ccd_functions || 'N/A' }} |
            | Cheminformatics (chemi_*) | ${{ steps.coverage.outputs.chemi_coverage || 'N/A' }}% | ${{ steps.coverage.outputs.chemi_endpoints || 'N/A' }} | ${{ steps.coverage.outputs.chemi_functions || 'N/A' }} |

            ### Review Checklist
            - [ ] Review schema changes for breaking API modifications
            - [ ] Review generated function stubs for correctness
            - [ ] Check if any existing package functions need updates
            - [ ] Run tests to verify compatibility

            ---
            Generated by GitHub Actions
          branch: automated/schema-update
          delete-branch: true
          labels: |
            automated
            schemas
